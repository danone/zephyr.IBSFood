---
title: "IBS food exploration"
output:
  html_notebook:
    author: "Julien Tap"
    code_folding: hide
    highlight: tango
    mathjax: null
    theme: cerulean
    toc: yes
    toc_float: yes
  html_document:
    toc: yes
date: '`r Sys.Date()`'
---


## Introduction 


The aim of this notebook is to do **Dietary habit characterization and nutrient intake in the study**. We plan to explore several items:

-	Food tree description and grouping food items using DMM based on nutrient (focus on few example)
-	Description of data available (4d recall, swedish db, nutrient and fodmap)
-	“ecological” analysis of food tree : unifrac distance => Plant based vs animal based
-	Healthy vs IBS (alcool, candy) and FODMAP [in short]
-	NutriScore like computation (vs Snacking?), check for other diet index



```{r, message=FALSE, warning=FALSE}
#library(tidyverse)
library(dplyr)
library(magrittr)
library(reshape2)
library(circlepackeR)
#library(vegan)
library(ggplot2)
#library(DirichletMultinomial)

library(IBSMicrobiota)
library(ade4)
library(phyloseq)

devtools::load_all()

```



## Import IBS study dataset

```{r}

# IBS metadata
data("IBSData")


# IBS food data
data("food_data")
data("food_group_levels")
data("food_swe")

```


## Basics statistics

IBS dataset had OTU count table, taxonomic table and several metadata asssociated to sample.

```{r}


IBSData


```

- *food_data* is the 4 day diet recall dataset
- *food_group_levels* is the food tree hierarchy including a fourth level made with DMM model (see internal script in data-raw/ folder)
- *food_swe* is the nutrient description of food items from National Swedish food database

```{r}


food_data

food_group_levels

food_swe



```

## Food tree exploration with food nutrient

let's explore de *food_group_levels*

```{r}

#a bit of cleaning
food_group_levels =
food_group_levels %>%
  rename(Food_items_swe = Livsmedelsnamn, Food_items_eng = Livsmedelsnamn_eng, Food_items_id = Livsmedelsnummer) %>%
  filter(used == "yes") %>%
  select(contains("Food")) %>%
  mutate(`Food groups lvl1` = `Food groups lvl1` %>% gsub("Chemicals","Others",.)) %>%
  mutate(`Food groups lvl1` = `Food groups lvl1` %>% gsub("Animal-based","Meat-based",.))
  
  
  
#a summary
food_group_levels %>%
  select(-Foodstuffs,-Food_items_swe, -Food_items_eng) %>%
  melt(id.vars="Food groups lvl0") %>%
  group_by(variable) %>%
  unique() %>%
  summarize(n=n())
  
  



```

Here is the complete nutrient table with associated hierachy

```{r}

food_swe %>%
  rename(Food_items_swe = Livsmedelsnamn, Food_items_id = Livsmedelsnummer) %>%
  merge(food_group_levels,.,by=c("Food_items_swe","Food_items_id")) 



```

### focus on some food category

example with:
1) Yoghurt was divided into two food OTU
2) Pasta, Rice and Cereals into four food OTU


Focus on some food category **"Food groups lvl3"** to explore how DMM divided into meaninful **"food OTU"** (called **"Food groups lvl4"**)

```{r, fig.height=5, fig.width=10}

## focus on "yogurt"

food_swe %>%
  rename(Food_items_swe = Livsmedelsnamn, Food_items_id = Livsmedelsnummer) %>%
  merge(food_group_levels %>% select(Food_items_swe,Food_items_eng,Food_items_id,`Food groups lvl3`,`Food groups lvl4`),.,by=c("Food_items_swe","Food_items_id")) %>%
  filter(`Food groups lvl3` == "yoghurt") %>%
  select(-Livsmedelsgrupp, -`Energi (kJ)(kJ)`) %>% 
  melt(id.vars=c("Food groups lvl4","Food_items_eng","Food_items_swe","Food_items_id","Food groups lvl3")) %>%
  filter(variable %in% c("Energi (kcal)(kcal)","Protein(g)","Fett(g)","Kolhydrater(g)")) %>%
  ggplot() + geom_boxplot(aes(x=`Food groups lvl4`, y=value, fill=`Food groups lvl4`)) +
  facet_wrap(~variable, scale="free_y") -> pA_yoghurt




food_swe %>%
  rename(Food_items_swe = Livsmedelsnamn, Food_items_id = Livsmedelsnummer) %>%
  merge(food_group_levels,.,by=c("Food_items_swe","Food_items_id")) %>%
  filter(`Food groups lvl3` == "yoghurt") %>%
  ggplot() + geom_point(aes(x=`Energi (kcal)(kcal)`, y=`Fett(g)`, col=`Food groups lvl4`)) +
  ggrepel::geom_text_repel(aes(x=`Energi (kcal)(kcal)`, y=`Fett(g)`, label=Food_items_eng), size=2) -> pB_yoghurt

cowplot::plot_grid(
  pA_yoghurt,
pB_yoghurt
)






```





```{r, fig.height=5, fig.width=12}

## focus on "Pasta, Rice and Cereals"


food_swe %>%
  rename(Food_items_swe = Livsmedelsnamn, Food_items_id = Livsmedelsnummer) %>%
  merge(food_group_levels %>% select(Food_items_swe,Food_items_eng,Food_items_id,`Food groups lvl3`,`Food groups lvl4`),.,by=c("Food_items_swe","Food_items_id")) %>%
  filter(`Food groups lvl3` == "pasta, rice cereals") %>%
  select(-Livsmedelsgrupp, -`Energi (kJ)(kJ)`) %>% 
  melt(id.vars=c("Food groups lvl4","Food_items_eng","Food_items_swe","Food_items_id","Food groups lvl3")) %>%
  filter(variable %in% c("Energi (kcal)(kcal)","Protein(g)","Fett(g)","Kolhydrater(g)","Salt(g)","Fibrer(g)")) %>%
  ggplot() + geom_boxplot(aes(x=`Food groups lvl4`, y=value, fill=`Food groups lvl4`)) +
  facet_wrap(~variable, scale="free_y") -> pA_cereals




food_swe %>%
  rename(Food_items_swe = Livsmedelsnamn, Food_items_id = Livsmedelsnummer) %>%
  merge(food_group_levels,.,by=c("Food_items_swe","Food_items_id")) %>%
  filter(`Food groups lvl3` == "pasta, rice cereals") %>%
  ggplot() + geom_point(aes(x=`Energi (kcal)(kcal)`, y=`Fibrer(g)`, col=`Food groups lvl4`), size=4, alpha=0.5) +
  ggrepel::geom_text_repel(aes(x=`Energi (kcal)(kcal)`, y=`Fibrer(g)`, label=Food_items_eng %>% gsub(" ","\n",.)), size=2) -> pB_cereals

cowplot::plot_grid(
  pA_cereals,
pB_cereals
)




```


### Interactive food tree 

```{r, fig.height=10, fig.width=10}

food_swe %>%
  rename(Food_items_swe = Livsmedelsnamn, Food_items_id = Livsmedelsnummer) %>%
  merge(food_group_levels,.,by=c("Food_items_swe","Food_items_id")) %>%
    mutate(pathString=paste(`Food groups lvl0`,`Food groups lvl1`,`Food groups lvl2`,`Food groups lvl3`, `Food groups lvl4`, Foodstuffs, sep="//")) %>%
    data.tree::as.Node(pathDelimiter = "//") -> food_tree

food_html = circlepackeR::circlepackeR(food_tree, size="Energi (kcal)(kcal)")

food_html

```





## food recall exploration



An average of **20** food items was recorded by Day by Individual.

```{r, fig.height=8, fig.width=8}

food_data %>%
  dim()


food_data %>%
  group_by(Identity, Day, Meal) %>%
  summarise(n=n()) %>%
  ggplot() + geom_bar(aes(x=Identity,y=n,fill=Meal),stat="identity") + facet_wrap(~Day, ncol=4) + coord_flip()


food_data %>%
  group_by(Identity, Day) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  group_by(Day) %>%
  summarise(mean=mean(n), median=median(n))


```


```{r}

food_group_levels

```


### Food alpha_diversity

```{r}

food_data %>%
  select(Identity,Day,Meal,Code,Foodstuffs,Gram) %>%
  rename(Food_items_id = Code) %>%
  merge(.,food_group_levels, by=c("Foodstuffs","Food_items_id")) %>%
  group_by(Identity, `Food groups lvl4`) %>%
  select(Identity, `Food groups lvl4`) %>%
  unique() %>%
  ungroup() %>%
  group_by(Identity) %>%
  summarise(n=n()) -> n_nutrient_food_group

n_nutrient_food_group %>%
  ggplot() + geom_histogram(aes(x=n)) + xlab("Number of different food nutrient based group")
  
  
```  
 
  
```{r}  


 food_data %>%
  select(Identity,Day,Meal,Code,Foodstuffs,Gram) %>%
  rename(Food_items_id = Code) %>%
  merge(.,food_group_levels, by=c("Foodstuffs","Food_items_id")) %>%
  group_by(Identity) %>%
  summarise(Gram=sum(Gram)) -> n_Gram

n_Gram %>% pull(Gram) %>% min

merge(n_nutrient_food_group,n_Gram,by="Identity") %>%
  merge(.,
     IBSData$metadata %>%
   select(Patient_ID,Health,Gender,SSgroup,IBS_subtypes) %>%
   unique(),
   by.y="Patient_ID",
   by.x="Identity"
     
   ) %>%
  melt(id.vars=c("Identity","n","Gram")) %>%
  ggplot() + geom_point(aes(x=n,y=Gram, col=value)) + facet_wrap(~variable) + scale_colour_manual(values=rainbow(12))


 food_data %>%
  select(Identity,Day,Meal,Code,Foodstuffs,Gram) %>%
  rename(Food_items_id = Code) %>%
  merge(.,food_group_levels, by=c("Foodstuffs","Food_items_id")) %>%
   merge(.,
     IBSData$metadata %>%
   select(Patient_ID,Health,Gender,SSgroup,IBS_subtypes) %>%
   unique(),
   by.y="Patient_ID",
   by.x="Identity"
     
     
   ) %>%
   group_by(Identity,Health,Gender,SSgroup,IBS_subtypes) %>%
   summarise(Gram=sum(Gram)) %>%
   melt(id.vars=c("Identity","Gram")) %>%
   
   ggplot() +  geom_boxplot(aes(y=Gram, x=value)) + facet_wrap(~variable, scale="free_x") 

 
 
 
```



```{r} 

  food_data %>%
  select(Identity,Day,Meal,Code,Foodstuffs,Gram) %>%
  rename(Food_items_id = Code) %>%
  merge(.,food_group_levels, by=c("Foodstuffs","Food_items_id")) %>%
  group_by(Identity, `Food groups lvl4`) %>%
  summarise(Gram=sum(Gram) %>% round(.,0) %>% as.integer()) %>%
  dcast(Identity~`Food groups lvl4`, value.var="Gram", fill=0) %>%
  tibble::column_to_rownames("Identity") %>%
  vegan::rarefy(sample=2500) %>%
  as.matrix() %>%
  as.data.frame() %>%
   merge(.,
     IBSData$metadata %>%
   select(Patient_ID,Health,Gender,SSgroup,IBS_subtypes) %>%
   unique(),
   by.y="Patient_ID",
   by.x="row.names"
     
     
   ) %>%
  rename(F_obs =V1) %>%
  melt(id.vars=c("Row.names","F_obs")) %>%
  
   ggplot() +  geom_boxplot(aes(y=F_obs, x=value)) + facet_wrap(~variable, scale="free_x") + 
  ylab("Number of food nutrient OTU\n(rarefied for 2500g)")

 
 
 

```



```{r}





```



### Food beta_diversity

Start to create phyloseq object and compute unifrac distance. Outgroup choosen to root the tree was **Vodka** food based item.

```{r}

food_data %>%
  merge(food_group_levels, by.x="Code",by.y="Food_items_id", all = FALSE) %>%
  select(-Foodstuffs.y) %>%
  dplyr::rename(Foodstuffs = Foodstuffs.x) %>%
  group_by(Identity, `Food groups lvl1`, `Food groups lvl2`, `Food groups lvl3`,`Food groups lvl4`) %>%
  summarise(Gram = sum(Gram)) %>%
  na.omit() %>%
  dcast(Identity ~ `Food groups lvl4`, value.var = "Gram",fill = 0 ) %>%
    tibble::column_to_rownames("Identity") %>%
  t() %>%
  #as_tibble %>%
  round() -> food_otu

#url = system.file("biom", "food.biom", package="IBSFood")
tre = system.file("biom", "food.tree", package="IBSFood")

#physeq = phyloseq::import_biom(url, treefilename = tre)
#phyloseq::import_biom("../inst/biom/food.biom", treefilename = tre) # this does not work

#better to do it manually
TREE=ape::read.tree(file=tre)

TREE$edge.length = rep(1, dim(TREE$edge)[1]) #important to add edge length to compute unifrac distance

TAX = tax_table(food_group_levels %>%
              select(`Food groups lvl1`, `Food groups lvl2`, `Food groups lvl3`,`Food groups lvl4`) %>%
              unique %>%
              na.omit() %>%
              filter(`Food groups lvl4` %in% rownames(food_otu)) %>% tibble::column_to_rownames("Food groups lvl4")%>% as.matrix)


OTU = otu_table(food_otu, taxa_are_rows = TRUE)
physeq=phyloseq::phyloseq(OTU,TAX,TREE)


phy_tree(physeq) <- ape::root(phy=phy_tree(physeq), outgroup="28_3", resolve.root=TRUE, interactive=FALSE) #outgroup is Vodka


#otu_wunifrac = phyloseq::distance(physeq, method="wunifrac")
food_unifrac = phyloseq::distance(physeq, method="unifrac")

#food_wunifrac = phyloseq::distance(physeq, method="wunifrac")

```




```{r, fig.height=6, fig.width=8}

unifrac_pco  = ade4::dudi.pco(food_unifrac %>% ade4::quasieuclid(), scannf=F, nf=3)

unifrac_pco$li %>%
ggplot() + geom_point(aes(x=A1,y=A2))

merge(OTU %>% prop.table(2) ,TAX, by="row.names") %>%
  rename(`Food groups lvl4` = Row.names) %>%
  melt(id.vars=c("Food groups lvl1","Food groups lvl2","Food groups lvl3","Food groups lvl4")) %>%
  melt(id.vars=c("variable","value")) -> food_df_tree
  
  colnames(food_df_tree) =c("Subject","Gram","Hierarchy","Type")
  
  food_df_tree %>%
    group_by(Subject,Hierarchy,Type) %>%
    summarise(Gram=sum(Gram%>%as.numeric)) %>%
    merge(.,unifrac_pco$li,by.x="Subject", by.y="row.names") %>%
    group_by(Hierarchy,Type) %>%
    summarize(cor_A1 = cor(Gram, A1, method="spearman"), cor_A2=cor(Gram, A2, method="spearman")) -> cor_food_tree_res
    

# compute Meat/Plant ratio
  merge(OTU %>% prop.table(2) ,TAX, by="row.names") %>%
    as.data.frame %>%
    rename(`Food groups lvl4` = Row.names) %>%
    melt(id.vars=c("Food groups lvl1","Food groups lvl2","Food groups lvl3","Food groups lvl4")) %>%
    group_by(variable,`Food groups lvl1`) %>%
    summarize(Gram_prop = sum(value)) %>%
    dcast(variable~`Food groups lvl1`) %>%
    mutate(meat_plant_ratio = log2(`Meat-based`+0.001/`Plant-based`+0.001)) %>%
    merge(.,unifrac_pco$li, by.x="variable", by.y="row.names") %>%
    ggplot() + geom_point(aes(x=A1*2,y=A2*2, col=meat_plant_ratio %>% scale(scale = FALSE)), size=4, alpha=0.75) + 
    scale_color_gradient2("") + theme_dark() +
    
    geom_point(data=cor_food_tree_res %>% filter(abs(cor_A1)>0.3 | abs(cor_A2)>0.3 ), aes(x=cor_A1,y = cor_A2)) + ggrepel::geom_text_repel(data=cor_food_tree_res %>% filter(abs(cor_A1)>0.3 | abs(cor_A2)>0.3 ), aes(x=cor_A1,y = cor_A2,label=Type))
  
  
    
    # cor_food_tree_res %>%
    #   ggplot() + geom_point(aes(x=cor_A1,y = cor_A2)) + ggrepel::geom_text_repel(data=cor_food_tree_res %>% filter(abs(cor_A1)>0.3 | abs(cor_A2)>0.3 ), aes(x=cor_A1,y = cor_A2,label=Type))
    # 
  
    

```




```{r}

cor_food_tree_res

food_group_levels %>%
  filter(`Food groups lvl2` == "Coffee and tea")


```


##L Test NutriScore



```{r}

#TO DO: add "drink" boolean value in food table

food_swe %>%
  merge(food_group_levels, by.x="Livsmedelsnummer" , by.y="Food_items_id") %>%
  rename(Food_items_id = Livsmedelsnummer) %>%
  merge(food_fruit, by="Foodstuffs") %>% 
  group_by(Foodstuffs,Food_items_id,`Food groups lvl1`,`Food groups lvl2`,`Food groups lvl3`,`Food groups lvl4`) %>%
  summarise(
    
    nutriscore=nutriscore(
    
    cal=`Energi (kJ)(kJ)`,
  protein=`Protein(g)`,
  fat=`Fett(g)`,
  carbohydrate=`Kolhydrater(g)`,
  fibre=`Fibrer(g)`,
  sodium=`Natrium(mg)`,
  fruit = `fruit(%)`,
  type= "others"
    
    
  )$score_final
  
  
  
  ) %>%
  ungroup() %>%
  group_by(`Food groups lvl1`,`Food groups lvl2`,`Food groups lvl3`,`Food groups lvl4`) %>%
  summarise(nutriscore=mean(nutriscore)) %>%
  filter(`Food groups lvl1` != "Alcohol") %>%
  #filter(`Food groups lvl1` == "Meat-based") %>%
  merge(.,cor_food_tree_res, by.x="Food groups lvl4", by.y= "Type") -> nutriscore_food_group
  
cor.test(nutriscore_food_group$cor_A2,nutriscore_food_group$nutriscore, method="pearson")
  
  nutriscore_food_group %>%
  ggplot() +  geom_point(aes(x=cor_A2, y=nutriscore, col=`Food groups lvl1`), size=4) + scale_color_brewer(type="qual") + 
    ggrepel::geom_text_repel(aes(x=cor_A2, y=nutriscore, label=`Food groups lvl2`), size=2)



```



```{r}
  merge(OTU %>% prop.table(2) ,TAX, by="row.names") %>%
    as.data.frame %>%
    rename(`Food groups lvl4` = Row.names) %>%
    melt(id.vars=c("Food groups lvl1","Food groups lvl2","Food groups lvl3","Food groups lvl4")) %>%
    group_by(variable,`Food groups lvl1`) %>%
    summarize(Gram_prop = sum(value)) %>%
    dcast(variable~`Food groups lvl1`) %>%
    mutate(meat_plant_ratio = log2(`Meat-based`+0.001/`Plant-based`+0.001)) %>%
    merge(.,unifrac_pco$li, by.x="variable", by.y="row.names") %>%
    ggplot() + geom_point(aes(x=A1*2,y=A2*2, col=meat_plant_ratio %>% scale(scale = FALSE)), size=4, alpha=0.75) + 
    scale_color_gradient2("") + theme_dark() +
    
    geom_point(data=nutriscore_food_group %>% filter(abs(cor_A1)>0.3 | abs(cor_A2)>0.3 ), aes(x=cor_A1,y = cor_A2, size=nutriscore)) + ggrepel::geom_text_repel(data=nutriscore_food_group %>% filter(abs(cor_A1)>0.3 | abs(cor_A2)>0.3 ), aes(x=cor_A1,y = cor_A2,label=`Food groups lvl3`))




```

