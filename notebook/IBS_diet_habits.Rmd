---
title: "IBS food exploration"
output:
  html_notebook:
    author: "Julien Tap"
    code_folding: hide
    highlight: tango
    mathjax: null
    theme: cerulean
    toc: yes
    toc_float: yes
  html_document:
    toc: yes
date: '`r Sys.Date()`'
---


## Introduction 


The aim of this notebook is to do **Dietary habit characterization and nutrient intake in the study**. We plan to explore several items:

-	Food tree description and grouping food items using DMM based on nutrient (focus on few example)
-	Description of data available (4d recall, swedish db, nutrient and fodmap)
-	“ecological” analysis of food tree : unifrac distance => Plant based vs animal based
-	Healthy vs IBS (alcool, candy) and FODMAP [in short]
-	NutriScore like computation (vs Snacking?), check for other diet index



```{r, message=FALSE, warning=FALSE}
#library(tidyverse)
library(dplyr)
library(magrittr)
library(reshape2)
library(circlepackeR)
#library(vegan)
library(ggplot2)
#library(DirichletMultinomial)

library(IBSMicrobiota)
library(ade4)
library(phyloseq)
library(tidybayes)

devtools::load_all()

```



## Import IBS study dataset

```{r}

# IBS metadata
data("IBSData")


# IBS food data
data("food_data")
data("food_group_levels")
data("food_swe")

```


## Basics statistics

IBS dataset had OTU count table, taxonomic table and several metadata asssociated to sample.

```{r}


IBSData


```

- *food_data* is the 4 day diet recall dataset
- *food_group_levels* is the food tree hierarchy including a fourth level made with DMM model (see internal script in data-raw/ folder)
- *food_swe* is the nutrient description of food items from National Swedish food database

```{r}


food_data

food_group_levels

food_swe



```

## Food tree exploration with food nutrient

let's explore de *food_group_levels*

```{r}

#a bit of cleaning
food_group_levels =
food_group_levels %>%
  rename(Food_items_swe = Livsmedelsnamn, Food_items_eng = Livsmedelsnamn_eng, Food_items_id = Livsmedelsnummer) %>%
  filter(used == "yes") %>%
  select(contains("Food")) %>%
  mutate(`Food groups lvl1` = `Food groups lvl1` %>% gsub("Chemicals","Others",.)) %>%
  mutate(`Food groups lvl1` = `Food groups lvl1` %>% gsub("Animal-based","Meat-based",.))
  
  
  
#a summary
food_group_levels %>%
  select(-Foodstuffs,-Food_items_swe, -Food_items_eng) %>%
  melt(id.vars="Food groups lvl0") %>%
  group_by(variable) %>%
  unique() %>%
  summarize(n=n())
  
  



```

Here is the complete nutrient table with associated hierachy

```{r}

food_swe %>%
  rename(Food_items_swe = Livsmedelsnamn, Food_items_id = Livsmedelsnummer) %>%
  merge(food_group_levels,.,by=c("Food_items_swe","Food_items_id")) 



```

### focus on some food category

example with:
1) Yoghurt was divided into two food OTU
2) Pasta, Rice and Cereals into four food OTU


Focus on some food category **"Food groups lvl3"** to explore how DMM divided into meaninful **"food OTU"** (called **"Food groups lvl4"**)

```{r, fig.height=5, fig.width=10}

## focus on "yogurt"

food_swe %>%
  rename(Food_items_swe = Livsmedelsnamn, Food_items_id = Livsmedelsnummer) %>%
  merge(food_group_levels %>% select(Food_items_swe,Food_items_eng,Food_items_id,`Food groups lvl3`,`Food groups lvl4`),.,by=c("Food_items_swe","Food_items_id")) %>%
  filter(`Food groups lvl3` == "yoghurt") %>%
  select(-Livsmedelsgrupp, -`Energi (kJ)(kJ)`) %>% 
  melt(id.vars=c("Food groups lvl4","Food_items_eng","Food_items_swe","Food_items_id","Food groups lvl3")) %>%
  filter(variable %in% c("Energi (kcal)(kcal)","Protein(g)","Fett(g)","Kolhydrater(g)")) %>%
  ggplot() + geom_boxplot(aes(x=`Food groups lvl4`, y=value, fill=`Food groups lvl4`)) +
  facet_wrap(~variable, scale="free_y") -> pA_yoghurt




food_swe %>%
  rename(Food_items_swe = Livsmedelsnamn, Food_items_id = Livsmedelsnummer) %>%
  merge(food_group_levels,.,by=c("Food_items_swe","Food_items_id")) %>%
  filter(`Food groups lvl3` == "yoghurt") %>%
  ggplot() + geom_point(aes(x=`Energi (kcal)(kcal)`, y=`Fett(g)`, col=`Food groups lvl4`)) +
  ggrepel::geom_text_repel(aes(x=`Energi (kcal)(kcal)`, y=`Fett(g)`, label=Food_items_eng), size=2) -> pB_yoghurt

cowplot::plot_grid(
  pA_yoghurt,
pB_yoghurt
)

ggsave("yogurt_clustering.pdf")




```





```{r, fig.height=5, fig.width=12}

## focus on "Pasta, Rice and Cereals"


food_swe %>%
  rename(Food_items_swe = Livsmedelsnamn, Food_items_id = Livsmedelsnummer) %>%
  merge(food_group_levels %>% select(Food_items_swe,Food_items_eng,Food_items_id,`Food groups lvl3`,`Food groups lvl4`),.,by=c("Food_items_swe","Food_items_id")) %>%
  filter(`Food groups lvl3` == "pasta, rice cereals") %>%
  select(-Livsmedelsgrupp, -`Energi (kJ)(kJ)`) %>% 
  melt(id.vars=c("Food groups lvl4","Food_items_eng","Food_items_swe","Food_items_id","Food groups lvl3")) %>%
  filter(variable %in% c("Energi (kcal)(kcal)","Protein(g)","Fett(g)","Kolhydrater(g)","Salt(g)","Fibrer(g)")) %>%
  ggplot() + geom_boxplot(aes(x=`Food groups lvl4`, y=value, fill=`Food groups lvl4`)) +
  facet_wrap(~variable, scale="free_y") -> pA_cereals




food_swe %>%
  rename(Food_items_swe = Livsmedelsnamn, Food_items_id = Livsmedelsnummer) %>%
  merge(food_group_levels,.,by=c("Food_items_swe","Food_items_id")) %>%
  filter(`Food groups lvl3` == "pasta, rice cereals") %>%
  ggplot() + geom_point(aes(x=`Salt(g)`, y=`Protein(g)`, col=`Food groups lvl4`), size=4, alpha=0.5) +
  ggrepel::geom_text_repel(aes(x=`Salt(g)`, y=`Protein(g)`, label=Food_items_eng %>% gsub(" ","\n",.)), size=2) -> pB_cereals

cowplot::plot_grid(
  pA_cereals,
pB_cereals
)

ggsave("cereals_clustering.pdf")


```


### Interactive food tree 

```{r, fig.height=10, fig.width=10}

food_swe %>%
  rename(Food_items_swe = Livsmedelsnamn, Food_items_id = Livsmedelsnummer) %>%
  merge(food_group_levels,.,by=c("Food_items_swe","Food_items_id")) %>%
    mutate(pathString=paste(`Food groups lvl0`,`Food groups lvl1`,`Food groups lvl2`,`Food groups lvl3`, `Food groups lvl4`, Foodstuffs, sep="//")) %>%
    data.tree::as.Node(pathDelimiter = "//") -> food_tree

food_html = circlepackeR::circlepackeR(food_tree, size="Energi (kcal)(kcal)")

food_html

```





## food recall exploration



An average of **20** food items was recorded by Day by Individual.

```{r, fig.height=8, fig.width=8}

food_data %>%
  dim()


food_data %>%
  group_by(Identity, Day, Meal) %>%
  summarise(n=n()) %>%
  ggplot() + geom_bar(aes(x=Identity,y=n,fill=Meal),stat="identity", color="grey") + 
  facet_wrap(~Day, ncol=4) + coord_flip() + theme(axis.text.y=element_blank()) + scale_fill_brewer(type="qual")

ggsave("Meal_per_day_subject.pdf")

food_data %>%
  group_by(Identity, Day) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  group_by(Day) %>%
  summarise(mean=mean(n), median=median(n))


```


```{r}

food_group_levels

```


### Food alpha_diversity

```{r}

food_data %>%
  select(Identity,Day,Meal,Code,Foodstuffs,Gram) %>%
  rename(Food_items_id = Code) %>%
  merge(.,food_group_levels, by=c("Foodstuffs","Food_items_id")) %>%
  group_by(Identity, `Food groups lvl4`) %>%
  select(Identity, `Food groups lvl4`) %>%
  unique() %>%
  ungroup() %>%
  group_by(Identity) %>%
  summarise(n=n()) -> n_nutrient_food_group

n_nutrient_food_group %>%
  ggplot() + geom_histogram(aes(x=n), bins=30) + xlab("Number of different food nutrient based group")
  
ggsave("food_otu_count_distribution.pdf")

# mod = mclust::densityMclust(n_nutrient_food_group$n) # no bimodality
# plot(mod)

  
```  
 
  
```{r}  


 food_data %>%
  select(Identity,Day,Meal,Code,Foodstuffs,Gram) %>%
  rename(Food_items_id = Code) %>%
  merge(.,food_group_levels, by=c("Foodstuffs","Food_items_id")) %>%
  group_by(Identity) %>%
  summarise(Gram=sum(Gram)) -> n_Gram

n_Gram %>% pull(Gram) %>% summary



merge(n_nutrient_food_group,n_Gram,by="Identity") %>%
  merge(.,
     IBSData$metadata %>%
   select(Patient_ID,Health,Gender,SSgroup,IBS_subtypes) %>%
   unique(),
   by.y="Patient_ID",
   by.x="Identity"
     
   ) %>%
  melt(id.vars=c("Identity","n","Gram")) %>%
  ggplot() + geom_point(aes(x=n,y=Gram, col=value)) + facet_wrap(~variable) + scale_colour_manual(values=rainbow(12))

ggsave("Gram_nb_food_item.pdf")


 food_data %>%
  select(Identity,Day,Meal,Code,Foodstuffs,Gram) %>%
  rename(Food_items_id = Code) %>%
  merge(.,food_group_levels, by=c("Foodstuffs","Food_items_id")) %>%
   merge(.,
     IBSData$metadata %>%
   select(Patient_ID,Health,Gender,SSgroup,IBS_subtypes) %>%
   unique(),
   by.y="Patient_ID",
   by.x="Identity"
     
     
   ) %>%
   group_by(Identity,Health,Gender,SSgroup,IBS_subtypes) %>%
   summarise(Gram=sum(Gram)) %>%
   melt(id.vars=c("Identity","Gram")) %>%
   
   ggplot() +  geom_boxplot(aes(y=Gram, x=value)) + facet_wrap(~variable, scale="free_x") 

 
ggsave("Gram_per_health_status.pdf") 
 
 
```



```{r} 

  food_data %>%
  select(Identity,Day,Meal,Code,Foodstuffs,Gram) %>%
  rename(Food_items_id = Code) %>%
  merge(.,food_group_levels, by=c("Foodstuffs","Food_items_id")) %>%
  group_by(Identity, `Food groups lvl4`) %>%
  summarise(Gram=sum(Gram) %>% round(.,0) %>% as.integer()) %>%
  dcast(Identity~`Food groups lvl4`, value.var="Gram", fill=0) %>%
  tibble::column_to_rownames("Identity") %>%
  vegan::rarefy(sample=2500) %>%
  as.matrix() %>%
  as.data.frame() %>%
   merge(.,
     IBSData$metadata %>%
   select(Patient_ID,Health,Gender,SSgroup,IBS_subtypes) %>%
   unique(),
   by.y="Patient_ID",
   by.x="row.names"
     
     
   ) %>%
  rename(F_obs =V1) %>%
  melt(id.vars=c("Row.names","F_obs")) %>%
  
   ggplot() +  geom_boxplot(aes(y=F_obs, x=value)) + facet_wrap(~variable, scale="free_x") + 
  ylab("Number of food nutrient OTU\n(rarefied for 2500g)")

ggsave("food_otu_rarefied.pdf")
 
 food_data %>%
  select(Identity,Day,Meal,Code,Foodstuffs,Gram) %>%
  rename(Food_items_id = Code) %>%
  merge(.,food_group_levels, by=c("Foodstuffs","Food_items_id")) %>%
  group_by(Identity, `Food groups lvl4`) %>%
  summarise(Gram=sum(Gram) %>% round(.,0) %>% as.integer()) %>%
  dcast(Identity~`Food groups lvl4`, value.var="Gram", fill=0) %>%
  tibble::column_to_rownames("Identity") %>%
  vegan::rarefy(sample=2500) %>%
  as.matrix() %>%
  as.data.frame() %>%
   merge(.,
     IBSData$metadata %>%
   select(Patient_ID,Health,Gender,SSgroup,IBS_subtypes) %>%
   unique(),
   by.y="Patient_ID",
   by.x="row.names"
     
     
   ) %>%
  rename(F_obs =V1) %>%
  melt(id.vars=c("Row.names","F_obs")) %>%
   group_by(variable) %>%
   do(pairwise.wilcox.test(.$F_obs,.$value, data=., p.adjust.methods="none") %>% broom::tidy())
 

```



```{r}





```



### Food beta_diversity

Start to create phyloseq object and compute unifrac distance. Outgroup choosen to root the tree was **Vodka** food based item.

```{r}

food_data %>%
  merge(food_group_levels, by.x="Code",by.y="Food_items_id", all = FALSE) %>%
  select(-Foodstuffs.y) %>%
  dplyr::rename(Foodstuffs = Foodstuffs.x) %>%
  group_by(Identity, `Food groups lvl1`, `Food groups lvl2`, `Food groups lvl3`,`Food groups lvl4`) %>%
  summarise(Gram = sum(Gram)) %>%
  na.omit() %>%
  dcast(Identity ~ `Food groups lvl4`, value.var = "Gram",fill = 0 ) %>%
    tibble::column_to_rownames("Identity") %>%
  t() %>%
  #as_tibble %>%
  round() -> food_otu

#url = system.file("biom", "food.biom", package="IBSFood")
tre = system.file("biom", "food.tree", package="IBSFood")

#physeq = phyloseq::import_biom(url, treefilename = tre)
#phyloseq::import_biom("../inst/biom/food.biom", treefilename = tre) # this does not work

#better to do it manually
TREE=ape::read.tree(file=tre)

TREE$edge.length = rep(1, dim(TREE$edge)[1]) #important to add edge length to compute unifrac distance

TAX = tax_table(food_group_levels %>%
              select(`Food groups lvl1`, `Food groups lvl2`, `Food groups lvl3`,`Food groups lvl4`) %>%
              unique %>%
              na.omit() %>%
              filter(`Food groups lvl4` %in% rownames(food_otu)) %>% tibble::column_to_rownames("Food groups lvl4")%>% as.matrix)


OTU = otu_table(food_otu, taxa_are_rows = TRUE)
physeq=phyloseq::phyloseq(OTU,TAX,TREE)


phy_tree(physeq) <- ape::root(phy=phy_tree(physeq), outgroup="28_3", resolve.root=TRUE, interactive=FALSE) #outgroup is Vodka



food_unifrac = phyloseq::distance(physeq, method="unifrac")

save(food_unifrac, file="food_unifrac.dist")


#food_wunifrac = phyloseq::distance(physeq, method="wunifrac")

```


Compare first component with metadata

```{r, fig.height=6, fig.width=10, message=FALSE, warning=FALSE}

unifrac_pco  = ade4::dudi.pco(food_unifrac %>% ade4::quasieuclid(), scannf=F, nf=3)

unifrac_pco$li %>%
  merge(.,
     IBSData$metadata %>% 
       select(Patient_ID,Health,Gender,SSgroup,IBS_subtypes,Methanogens_qPCR, H2_group, CH4_group) %>% unique(),
   by.y="Patient_ID",
   by.x="row.names"
     
     
   ) %>%
  melt(id.vars=c("A1","A2","A3","Row.names")) %>%
  group_by(variable) %>%
  do(pairwise.wilcox.test(.$A1,.$value, data=.) %>% broom::tidy())

unifrac_pco$li %>%
  merge(.,
     IBSData$metadata %>% 
       select(Patient_ID,Health,Gender,SSgroup,IBS_subtypes,Methanogens_qPCR, H2_group, CH4_group) %>% unique(),
   by.y="Patient_ID",
   by.x="row.names"
     
     
   ) %>%
  melt(id.vars=c("A1","A2","A3","Row.names")) %>%
  group_by(variable) %>%
  do(pairwise.wilcox.test(.$A2,.$value, data=.) %>% broom::tidy())


unifrac_pco$li %>%
  merge(.,
     IBSData$metadata %>% 
       select(Patient_ID,Health,Gender,SSgroup,IBS_subtypes,Methanogens_qPCR, H2_group, CH4_group) %>% unique(),
   by.y="Patient_ID",
   by.x="row.names"
     
     
   ) %>%
  melt(id.vars=c("A1","A2","A3","Row.names")) %>%
  group_by(variable) %>%
  do(pairwise.wilcox.test(.$A3,.$value, data=.) %>% broom::tidy())



merge(OTU %>% prop.table(2) ,TAX, by="row.names") %>%
  rename(`Food groups lvl4` = Row.names) %>%
  melt(id.vars=c("Food groups lvl1","Food groups lvl2","Food groups lvl3","Food groups lvl4")) %>%
  melt(id.vars=c("variable","value")) -> food_df_tree
  
  colnames(food_df_tree) =c("Subject","Gram","Hierarchy","Type")
  
  food_df_tree %>%
    group_by(Subject,Hierarchy,Type) %>%
    summarise(Gram=sum(Gram%>%as.numeric)) %>%
    merge(.,unifrac_pco$li,by.x="Subject", by.y="row.names") %>%
    group_by(Hierarchy,Type) %>%
    summarize(cor_A1 = cor(Gram, A1, method="spearman"), cor_A2=cor(Gram, A2, method="spearman"), cor_A3=cor(Gram, A3, method="spearman")) -> cor_food_tree_res



unifrac_pco$li %>%
  merge(.,
     IBSData$metadata %>% 
       select(Patient_ID,Health,Gender,SSgroup,IBS_subtypes,Methanogens_qPCR, transit.days,H2_group,BSF.Mean_Frequenc_StoolPerDay) %>% unique(),
   by.y="Patient_ID",
   by.x="row.names"
     
     
   ) %>%
ggplot() + geom_point(aes(x=A1*2,y=A2*2, shape=Health, color=Gender), size=4) +
    
    geom_point(data=cor_food_tree_res %>% filter(abs(cor_A1)>0.3 | abs(cor_A2)>0.3 ), aes(x=cor_A1,y = cor_A2)) + ggrepel::geom_text_repel(data=cor_food_tree_res %>% filter(abs(cor_A1)>0.3 | abs(cor_A2)>0.3 ), aes(x=cor_A1,y = cor_A2,label=Type)) + 
    xlab("PCoA1") + ylab("PCoA2") -> food_tree_unifrac_pcoa_plot



unifrac_pco$li %>%
  merge(.,
     IBSData$metadata %>% 
       select(Patient_ID,Health,Gender,SSgroup,IBS_subtypes,Methanogens_qPCR, transit.days,H2_group,BSF.Mean_Frequenc_StoolPerDay) %>% unique(),
   by.y="Patient_ID",
   by.x="row.names"
     
     
   ) %>%
ggplot() + geom_point(aes(x=A1*2,y=A3*2, shape=Health, color=Gender), size=4) +
    
    geom_point(data=cor_food_tree_res %>% filter(abs(cor_A1)>0.3 | abs(cor_A3)>0.3 ), aes(x=cor_A1,y = cor_A3)) + ggrepel::geom_text_repel(data=cor_food_tree_res %>% filter(abs(cor_A1)>0.3 | abs(cor_A3)>0.3 ), aes(x=cor_A1,y = cor_A3,label=Type)) + 
    xlab("PCoA1") + ylab("PCoA3") -> food_tree_unifrac_pcoa_PC3_plot

food_tree_unifrac_pcoa_PC3_plot

unifrac_pco$li %>%
  merge(.,
     IBSData$metadata %>% 
       select(Patient_ID,Health,Gender,SSgroup,IBS_subtypes,Methanogens_qPCR, H2_group, CH4_group) %>% unique(),
   by.y="Patient_ID",
   by.x="row.names") %>%
  ggplot() + 
  geom_interval(data= . %>% group_by(Gender) %>% tidybayes::mean_qi(A1=A1*2 , .prob = c(.5, .66, .95, .99)) , aes(x=Gender, y=A1)) +
  #geom_jitter(aes(x=Gender, y=A1), width=0.1) +
  geom_point(data = . %>% group_by(Gender) %>% summarize(A1=median(A1*2)), aes(x=Gender, y=A1) , size=5, shape=18  ) + 
  scale_color_brewer("CI") + ylab("PCoA1") -> Gender_pcoa_plot






unifrac_pco$li %>%
  merge(.,
     IBSData$metadata %>% 
       select(Patient_ID,Health,Gender,SSgroup,IBS_subtypes,Methanogens_qPCR, H2_group, CH4_group) %>% unique(),
   by.y="Patient_ID",
   by.x="row.names") %>%
 ggplot() + 
  geom_interval(data= . %>% group_by(Health) %>% tidybayes::mean_qi(A2=A2*2 , .prob = c(.5, .66, .95, .99)) , aes(x=Health, y=A2)) +
  #geom_jitter(aes(x=Gender, y=A1), width=0.1) +
  geom_point(data = . %>% group_by(Health) %>% summarize(A2=median(A2*2)), aes(x=Health, y=A2) , size=5, shape=18  ) + 
  scale_color_brewer("CI") + ylab("PCoA2") -> Health_pcoa_plot


unifrac_pco$li %>%
  merge(.,
     IBSData$metadata %>% 
       select(Patient_ID,Health,Gender,SSgroup,IBS_subtypes,Methanogens_qPCR, H2_group, CH4_group) %>% unique(),
   by.y="Patient_ID",
   by.x="row.names") %>%
 ggplot() + 
  geom_interval(data= . %>% group_by(SSgroup) %>% tidybayes::mean_qi(A2=A2*2 , .prob = c(.5, .66, .95, .99)) , aes(x=SSgroup, y=A2)) +
  #geom_jitter(aes(x=Gender, y=A1), width=0.1) +
  geom_point(data = . %>% group_by(SSgroup) %>% summarize(A2=median(A2*2)), aes(x=SSgroup, y=A2) , size=5, shape=18  ) + 
  scale_color_brewer("CI") + ylab("PCoA2") -> Severity_pcoa_plot


cowplot::plot_grid(food_tree_unifrac_pcoa_plot,  cowplot::plot_grid(Gender_pcoa_plot,Health_pcoa_plot, nrow=2), rel_widths = c(4,1))


```



Check asssociations with Nutriscore and food items 

```{r}


merge(OTU %>% prop.table(2) ,TAX, by="row.names") %>%
  rename(`Food groups lvl4` = Row.names) %>%
  melt(id.vars=c("Food groups lvl1","Food groups lvl2","Food groups lvl3","Food groups lvl4")) %>%
  melt(id.vars=c("variable","value")) -> food_df_tree
  
  colnames(food_df_tree) =c("Subject","Gram","Hierarchy","Type")
  
  food_df_tree %>%
    group_by(Subject,Hierarchy,Type) %>%
    summarise(Gram=sum(Gram%>%as.numeric)) %>%
    merge(.,unifrac_pco$li,by.x="Subject", by.y="row.names") %>%
    group_by(Hierarchy,Type) %>%
    summarize(cor_A1 = cor(Gram, A1, method="spearman"), cor_A2=cor(Gram, A2, method="spearman")) -> cor_food_tree_res
    
  

# compute Meat/Plant ratio
  merge(OTU %>% prop.table(2) ,TAX, by="row.names") %>%
    as.data.frame %>%
    rename(`Food groups lvl4` = Row.names) %>%
    melt(id.vars=c("Food groups lvl1","Food groups lvl2","Food groups lvl3","Food groups lvl4")) %>%
    group_by(variable,`Food groups lvl1`) %>%
    summarize(Gram_prop = sum(value)) %>%
    dcast(variable~`Food groups lvl1`) %>%
    mutate(meat_plant_ratio = log2(`Meat-based`+0.001/`Plant-based`+0.001)) %>%
    merge(.,unifrac_pco$li, by.x="variable", by.y="row.names") -> meat_plant_ratio_df
  
  write.csv2(meat_plant_ratio_df, file="../inst/tables/meat_plant_ratio.csv")
  
  meat_plant_ratio_df  %>%
    ggplot() + geom_point(aes(x=A1*2,y=A2*2, col=meat_plant_ratio %>% scale(scale = FALSE)), size=4, alpha=0.75) + 
    scale_color_gradient2("Meat/Plant\nratio\n(centered,log2)") + theme_dark() +
    
    geom_point(data=cor_food_tree_res %>% filter(abs(cor_A1)>0.3 | abs(cor_A2)>0.3 ), aes(x=cor_A1,y = cor_A2)) + ggrepel::geom_text_repel(data=cor_food_tree_res %>% filter(abs(cor_A1)>0.3 | abs(cor_A2)>0.3 ), aes(x=cor_A1,y = cor_A2,label=Type)) + 
    xlab("PCoA1") + ylab("PCoA2")
  
  
    
    # cor_food_tree_res %>%
    #   ggplot() + geom_point(aes(x=cor_A1,y = cor_A2)) + ggrepel::geom_text_repel(data=cor_food_tree_res %>% filter(abs(cor_A1)>0.3 | abs(cor_A2)>0.3 ), aes(x=cor_A1,y = cor_A2,label=Type))
    # 
  
  
  merge(OTU %>% prop.table(2) ,TAX, by="row.names") %>%
    as.data.frame %>%
    rename(`Food groups lvl4` = Row.names) %>%
    melt(id.vars=c("Food groups lvl1","Food groups lvl2","Food groups lvl3","Food groups lvl4")) %>%
    group_by(variable,`Food groups lvl1`) %>%
    summarize(Gram_prop = sum(value)) %>%
    dcast(variable~`Food groups lvl1`) %>%
    mutate(meat_plant_ratio = log2(`Meat-based`+0.001/`Plant-based`+0.001)) %>%
    merge(.,unifrac_pco$li, by.x="variable", by.y="row.names") %>%
    ggplot() + geom_point(aes(x=A1*2,y=A2*2), size=4, alpha=0.75) + 
    scale_color_gradient2("Meat/Plant\nratio\n(centered,log2)") + theme_dark() +
    xlab("PCoA1") + ylab("PCoA2")
  
 
  merge(OTU %>% prop.table(2) ,TAX, by="row.names") %>%
    as.data.frame %>%
    rename(`Food groups lvl4` = Row.names) %>%
    melt(id.vars=c("Food groups lvl1","Food groups lvl2","Food groups lvl3","Food groups lvl4")) %>%
    group_by(variable,`Food groups lvl1`) %>%
    summarize(Gram_prop = sum(value)) %>%
    dcast(variable~`Food groups lvl1`) %>%
    mutate(meat_plant_ratio = log2(`Meat-based`+0.001/`Plant-based`+0.001)) %>%
    merge(.,unifrac_pco$li, by.x="variable", by.y="row.names") %>%
    write.csv2(., file="../inst/tables/meat_plant_ratio.csv")
   
  
  merge(OTU %>% prop.table(2) ,TAX, by="row.names") %>%
    as.data.frame %>%
    rename(`Food groups lvl4` = Row.names) %>%
    melt(id.vars=c("Food groups lvl1","Food groups lvl2","Food groups lvl3","Food groups lvl4")) %>%
    group_by(variable,`Food groups lvl1`) %>%
    summarize(Gram_prop = sum(value)) %>%
    dcast(variable~`Food groups lvl1`) %>%
    mutate(meat_plant_ratio = log2(`Meat-based`+0.001/`Plant-based`+0.001)) %>%
    merge(.,unifrac_pco$li, by.x="variable", by.y="row.names") %>%
    ggplot() + geom_point(aes(x=A1*2,y=meat_plant_ratio, col=meat_plant_ratio %>% scale(scale = FALSE)), size=4, alpha=0.75) + 
    scale_color_gradient2("Meat/Plant\nratio\n(log2)",low="green",mid="grey",high="red") + theme_bw() +
    xlab("PCoA1") + ylab("Meat/Plant based ratio (log2)") + guides(color=FALSE) -> meat_plant_pcoa_plot
  
  
  meat_plant_pcoa_plot
  

```





```{r}

cor_food_tree_res

food_group_levels %>%
  filter(`Food groups lvl2` == "Coffee and tea")


```


## Test NutriScore



```{r}

#TO DO: add "drink" boolean value in food table
food_swe %>%
  merge(food_group_levels, by.x="Livsmedelsnummer" , by.y="Food_items_id") %>%
  rename(Food_items_id = Livsmedelsnummer) %>%
  merge(food_fruit, by="Foodstuffs") %>% 
  group_by(Foodstuffs,Food_items_id,`Food groups lvl1`,`Food groups lvl2`,`Food groups lvl3`,`Food groups lvl4`) %>%
  mutate(type=ifelse(`Food groups lvl3` %in% 
           c("beverages", 
             "fruit juice",
             "soft drinks, diet", 
             "coffee and tea", 
             "soft drinks, not diet",
             "substitutes for milk"
             ),"drink","others")) %>%
  summarise(
    
    nutriscore=nutriscore(
    
    cal=`Energi (kJ)(kJ)`,
  protein=`Protein(g)`,
  fat=`Fett(g)`,
  carbohydrate=`Kolhydrater(g)`,
  fibre=`Fibrer(g)`,
  sodium=`Natrium(mg)`,
  fruit = `fruit(%)`,
  type= type
    
    
  )$score_final
  
  
  
  ) %>%
  ungroup() %>%
  group_by(`Food groups lvl1`,`Food groups lvl2`,`Food groups lvl3`,`Food groups lvl4`) %>%
  summarise(nutriscore=mean(nutriscore)) %>%
  filter(`Food groups lvl1` != "Alcohol") %>%
  #filter(`Food groups lvl1` == "Meat-based") %>%
  merge(.,cor_food_tree_res, by.x="Food groups lvl4", by.y= "Type") -> nutriscore_food_group

save(nutriscore_food_group, file="../data/nutriscore_food_group.rda")

#cor.test(nutriscore_food_group$cor_A1,nutriscore_food_group$nutriscore, method="spearman")  
cor.test(nutriscore_food_group$cor_A2,nutriscore_food_group$nutriscore, method="spearman")
#cor.test(nutriscore_food_group$cor_A3,nutriscore_food_group$nutriscore, method="spearman")
  
  nutriscore_food_group %>%
  ggplot() +  geom_point(aes(x=cor_A2, y=nutriscore, col=`Food groups lvl1`), size=4) + scale_color_brewer("Food groups",type="qual") + 
    #ggrepel::geom_text_repel(aes(x=cor_A2, y=nutriscore, label=`Food groups lvl2`), size=2) + 
    #geom_smooth(aes(x=cor_A2, y=nutriscore), se=FALSE, method="lm", col="red", linetype=3) + 
    theme_bw() + xlab("Association with PCoA2") + ylab("Nutritional Quality index\n(NutriScore)") -> nutriscore_pcoa_plot
  
 
nutriscore_pcoa_plot
  


    

```


```{r, fig.height=10, fig.width=12, message=FALSE, warning=FALSE}

diet_plot = cowplot::plot_grid(
  
  cowplot::plot_grid(
    food_tree_unifrac_pcoa_plot + cowplot::theme_cowplot(),  
    
    cowplot::plot_grid(
      Gender_pcoa_plot+ cowplot::theme_cowplot(),
      Health_pcoa_plot+ cowplot::theme_cowplot(), nrow=2),
    rel_widths = c(4,1.2)),
  
  cowplot::plot_grid(
    meat_plant_pcoa_plot+ cowplot::theme_cowplot(),
    nutriscore_pcoa_plot+ cowplot::theme_cowplot(), rel_widths = c(1,1.3)), nrow = 2, rel_heights = c(2,1))



print(diet_plot)

ggsave("Diet_PCoA_plot.pdf")


```



```{r, eval=FALSE, include=FALSE}
  merge(OTU %>% prop.table(2) ,TAX, by="row.names") %>%
    as.data.frame %>%
    rename(`Food groups lvl4` = Row.names) %>%
    melt(id.vars=c("Food groups lvl1","Food groups lvl2","Food groups lvl3","Food groups lvl4")) %>%
    group_by(variable,`Food groups lvl1`) %>%
    summarize(Gram_prop = sum(value)) %>%
    dcast(variable~`Food groups lvl1`) %>%
    mutate(meat_plant_ratio = log2(`Meat-based`+0.001/`Plant-based`+0.001)) %>%
    merge(.,unifrac_pco$li, by.x="variable", by.y="row.names") %>%
    ggplot() + geom_point(aes(x=A1*2,y=A2*2, col=meat_plant_ratio %>% scale(scale = FALSE)), size=4, alpha=0.75) + 
    scale_color_gradient2("") + theme_dark() +
    
    geom_point(data=nutriscore_food_group %>% filter(abs(cor_A2)>0.2 ), aes(x=cor_A1,y = cor_A2, size=nutriscore)) + ggrepel::geom_text_repel(data=nutriscore_food_group %>% filter(abs(cor_A2)>0.2 ), aes(x=cor_A1,y = cor_A2,label=`Food groups lvl3`))




```




## Nutrient analysis

Nutrient intake is associated with food tree

```{r}

data("nutrients_data")


  food_df_tree %>%
    group_by(Subject,Hierarchy,Type) %>%
    summarise(Gram=sum(Gram%>%as.numeric)) %>%
    merge(.,
          
         nutrients_data %>%
  select(1,4:40,48) %>%
  mutate(ID=ID %>% stringr::str_sub(end = 4)) %>%
  as.data.frame() %>%
  tibble::column_to_rownames(var = "ID") %>%
  dudi.pca(.,scannf=F, nf=3) %>% #.$co %>% tibble::rownames_to_column("nutrient") %>%  ggplot() +  geom_text(aes(x=Comp1,y=Comp2, label=nutrient))
  coinertia(.,unifrac_pco, scannf=F,nf=3) %>% #.$co %>% tibble::rownames_to_column("nutrient") %>%  ggplot() +  geom_text(aes(x=Comp1,y=Comp2, label=nutrient))
  .$lX  
          
          
          
          
          
          
          ,by.x="Subject", by.y="row.names") %>%
    group_by(Hierarchy,Type) %>%
    summarize(cor_A1 = cor(Gram, AxcX1, method="spearman"), cor_A2=cor(Gram, AxcX2, method="spearman")) -> cor_food_tree_res_bis
    


nutrients_data %>%
  select(1,4:40,48) %>%
  mutate(ID=ID %>% stringr::str_sub(end = 4)) %>%
  as.data.frame() %>%
  tibble::column_to_rownames(var = "ID") %>%
  dudi.pca(.,scannf=F, nf=3) %>% #.$co %>% tibble::rownames_to_column("nutrient") %>%  ggplot() +  geom_text(aes(x=Comp1,y=Comp2, label=nutrient))
  coinertia(.,unifrac_pco, scannf=F,nf=3) -> nutrient_food_tree_coinertia #.$co %>% tibble::rownames_to_column("nutrient") %>%  ggplot() +  geom_text(aes(x=Comp1,y=Comp2, label=nutrient))


  merge(nutrient_food_tree_coinertia$lX,
     IBSData$metadata %>% 
       select(Patient_ID,Health,Gender,SSgroup,IBS_subtypes,Methanogens_qPCR, transit.days,H2_group,BSF.Mean_Frequenc_StoolPerDay) %>% unique(),
   by.y="Patient_ID",
   by.x="row.names"
     
     
   ) %>%
ggplot() + geom_point(aes(x=AxcX1/10,y=AxcX2/10, shape=Health, color=Gender), size=4) +
    
    geom_point(data= cor_food_tree_res_bis %>%
                 filter(abs(cor_A1)>0.1 | abs(cor_A2)>0.1 ), aes(x=cor_A1,y = cor_A2)) + 
  
  
  ggrepel::geom_text_repel(data=cor_food_tree_res_bis %>% filter(abs(cor_A1)>0.3 | abs(cor_A2)>0.3 ), aes(x=cor_A1,y = cor_A2,label=Type)) + 
    ggrepel::geom_text_repel(data=nutrient_food_tree_coinertia$co %>% tibble::rownames_to_column("nutrient") , aes(x=Comp1*8, y=Comp2*8,label=nutrient)) +
    xlab("PCoA1") + ylab("PCoA2")
  
  
  
  
merge(nutrient_food_tree_coinertia$lX,
     IBSData$metadata %>% 
       select(Patient_ID,Health,Gender,SSgroup,IBS_subtypes,Methanogens_qPCR, transit.days,H2_group,BSF.Mean_Frequenc_StoolPerDay) %>% unique(),
   by.y="Patient_ID",
   by.x="row.names"
     
     
   ) %>% #ggplot() + geom_boxplot(aes(x=Health, y=AxcX2))
wilcox.test(data=., .$AxcX2~.$Health) %>% broom::tidy()








```









