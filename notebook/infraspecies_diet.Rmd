---
title: "MSP Infraspecies association with nutrient and foods"
output: html_notebook
---

## load library

```{r, message=FALSE, warning=FALSE}
library(ade4)
library(dplyr)
library(magrittr)
library(ggplot2)
library(reshape2)
library(phyloseq)
library(cowplot)
devtools::load_all()


```


## load infraspecies data table
```{r, message=FALSE, warning=FALSE}

infraspecies = readr::read_csv2(system.file("infraspecies", "infraspecies_table_full.csv", package="IBSFood"))[,-1]


meat_plant_ratio = readr::read_csv2(system.file("tables", "meat_plant_ratio.csv", package="IBSFood"))[,-1]

```

## correlation analyis

```{r}


rbind(
infraspecies %>%
  mutate_at(vars(contains("M", ignore.case = F)),function(x){x/sum(x)}) %>%
  select(contains("M", ignore.case = F),phylum) %>%
  group_by(phylum) %>%
  summarise_all(sum) %>%
  reshape2::melt(id.vars="phylum") %>%
  mutate(taxa = "phylum") %>%
  dplyr::rename(tax_variable = phylum),


infraspecies %>%
  mutate_at(vars(contains("M", ignore.case = F)),function(x){x/sum(x)}) %>%
  select(contains("M", ignore.case = F),phylum,family) %>%
  group_by(phylum,family) %>%
  summarise_all(sum) %>%
  ungroup() %>%
  select(-phylum) %>%
  reshape2::melt(id.vars="family")%>%
  mutate(taxa = "family") %>%
  dplyr::rename(tax_variable = family),


infraspecies %>%
  mutate_at(vars(contains("M", ignore.case = F)),function(x){x/sum(x)}) %>%
  select(contains("M", ignore.case = F),phylum,family,genus) %>%
  group_by(phylum,family,genus) %>%
  summarise_all(sum) %>%
  ungroup() %>%
  select(-phylum,-family) %>%
  reshape2::melt(id.vars="genus") %>%
  mutate(taxa = "genus") %>%
  dplyr::rename(tax_variable = genus),


infraspecies %>%
  mutate_at(vars(contains("M", ignore.case = F)),function(x){x/sum(x)}) %>%
  select(contains("M", ignore.case = F),phylum,family,genus,msp_name) %>%
  group_by(phylum,family,genus,msp_name) %>%
  summarise_all(sum) %>%
  ungroup() %>%
  select(-phylum,-family,-genus) %>%
  reshape2::melt(id.vars="msp_name") %>%
  mutate(taxa = "MSP") %>%
  dplyr::rename(tax_variable = msp_name),


infraspecies %>%
  mutate_at(vars(contains("M", ignore.case = F)),function(x){x/sum(x)}) %>%
  select(contains("M", ignore.case = F),phylum,family,genus,msp_name, msp_name_partition) %>%
  group_by(phylum,family,genus,msp_name, msp_name_partition) %>%
  summarise_all(sum) %>%
  ungroup() %>%
  select(-phylum,-family,-genus, -msp_name) %>%
  reshape2::melt(id.vars="msp_name_partition") %>%
  mutate(taxa = "Infraspecies") %>%
  dplyr::rename(tax_variable = msp_name_partition)
) -> compo_taxa_melt


compo_taxa_melt %>% head

```





### load nutrient data
```{r, eval=FALSE, include=FALSE}
data("nutrients_data")

nutrients_data %>%
  reshape2::melt(id.vars="ID") %>%
  merge(.,compo_taxa_melt, by.y="variable", by.x="ID") -> compo_taxa_nutrient_melt
  


compo_taxa_nutrient_melt %>% 
  #filter(variable == "Niek _mg" | tax_variable == "msp_1265_unassigned" | tax_variable =="msp_0849_cl_1"| tax_variable == "msp_0849") %>%
  group_by(taxa,tax_variable,variable) %>%
  summarize(cor = cor(value.x,value.y, method="spearman")) -> nutrient_taxa_cor
  
write.csv2(nutrient_taxa_cor, file="nutrient_taxa_cor.csv")

nutrient_taxa_cor %>%
  ggplot() + geom_density(aes(x=abs(cor), fill=taxa), alpha=0.5)


```


### analysis
```{r}


infraspecies %>% 
  mutate_at(vars(contains("M", ignore.case = F)),function(x){x/sum(x)}) %>%
  select(contains("M", ignore.case = F), msp_name_partition) %>%
  tibble::column_to_rownames("msp_name_partition") %>%
  t %>% as.data.frame() %>%
  merge(.,nutrients_data, by.x="row.names", by.y="ID") -> infraspecies_nutrient_df



infraspecies %>% 
  mutate_at(vars(contains("M", ignore.case = F)),function(x){x/sum(x)}) %>%
  select(contains("M", ignore.case = F), msp_name) %>%
  group_by(msp_name) %>%
  summarise_at(vars(contains("M", ignore.case = F)),sum) %>%
  tibble::column_to_rownames("msp_name") %>%
  t %>% as.data.frame() %>%
  merge(.,nutrients_data, by.x="row.names", by.y="ID") -> MSP_nutrient_df



dim(infraspecies_nutrient_df)
dim(MSP_nutrient_df)


dim(nutrients_data)


cor(log10(infraspecies_nutrient_df[2:(1838-49)]+10^-6),infraspecies_nutrient_df[(1838-48):1838], method="pearson") %>% 
  reshape2::melt() %>%
  filter(abs(value) > 0.5) %>%
  merge(.,infraspecies %>% select(species, msp_name, msp_name_partition), by.x="Var1", by.y="msp_name_partition") %>% select(-msp_name) %>%
  arrange(desc(abs(value)))



cor(log10(MSP_nutrient_df[2:(1481-49)]+10^-6),MSP_nutrient_df[(1481-48):1481], method="pearson") %>% 
  reshape2::melt() %>%
  filter(abs(value) > 0.5) %>%
  merge(.,infraspecies %>% select(species, msp_name), by.x="Var1", by.y="msp_name") %>%
  arrange(desc(abs(value)))



```

## compute MSP infraspecies distance matrix

```{r}

infraspecies_jsd = BiotypeR::dist.JSD(infraspecies %>% 
                                        mutate_at(vars(contains("M", ignore.case = F)),function(x){x/sum(x)}) %>% select(contains("M",ignore.case = F)))

save(infraspecies_jsd, file="infraspecies_jsd")


infraspecies %>% 
  group_by(phylum) %>%
  summarise_at(vars(contains("M", ignore.case = F)),
    function(x){sum(x)}) %>%
  ungroup() %>%
  mutate_at(vars(contains("M", ignore.case = F)),
    function(x){x/sum(x)}) %>% 
  select(contains("M",ignore.case = F)) %>%
  BiotypeR::dist.JSD() -> phylum_jsd

save(phylum_jsd, file="phylum_jsd")



infraspecies %>% 
  group_by(genus) %>%
  summarise_at(vars(contains("M", ignore.case = F)),
    function(x){sum(x)}) %>%
  ungroup() %>%
  mutate_at(vars(contains("M", ignore.case = F)),
    function(x){x/sum(x)}) %>% 
  select(contains("M",ignore.case = F)) %>%
  BiotypeR::dist.JSD() -> genus_jsd

save(genus_jsd, file="genus_jsd")



infraspecies %>% 
  group_by(species) %>%
  summarise_at(vars(contains("M", ignore.case = F)),
    function(x){sum(x)}) %>%
  ungroup() %>%
  mutate_at(vars(contains("M", ignore.case = F)),
    function(x){x/sum(x)}) %>% 
  select(contains("M",ignore.case = F)) %>%
  BiotypeR::dist.JSD() -> species_jsd

save(species_jsd, file="species_jsd")





tre = system.file("biom", "infraspecies.tree", package="IBSFood")


infraspecies.tree = ape::read.tree(file=tre)

infraspecies.tree$edge.length = rep(1, dim(infraspecies.tree$edge)[1]) #important to add edge length to compute unifrac distance

TAX = phyloseq::tax_table(infraspecies %>%
              select(superkingdom, phylum, class, order, family, genus, species, msp_name, msp_name_partition) %>%
              unique %>%
              na.omit() %>%
              tibble::column_to_rownames("msp_name_partition")%>% as.matrix)


OTU = phyloseq::otu_table(infraspecies %>% select(contains("M", ignore.case = F),msp_name_partition) %>% tibble::column_to_rownames("msp_name_partition")%>% as.matrix, taxa_are_rows = TRUE)
OTU = OTU %>% multiply_by(50*10^6) %>% round() 

physeq=phyloseq::phyloseq(OTU,TAX,infraspecies.tree)

#phyloseq::taxa_names(physeq)

select = 
infraspecies %>% 
  reshape2::melt(id.vars=c("msp_name_partition","msp_name","species","genus","family","order","class","phylum","superkingdom")) %>%
  group_by(variable) %>%
  mutate(prop=value/sum(value)) %>% 
  ungroup %>%
  group_by(msp_name) %>%
  filter(any(prop>0.01)) %>%
  ungroup %>%
  #group_by(variable) %>%
  #summarize(sum=sum(prop))
  reshape2::dcast(msp_name_partition + msp_name + species + genus + family + order + class + phylum + superkingdom ~ variable) %>%
  .$msp_name_partition


physeq = phyloseq::prune_taxa(select,physeq)



phyloseq::phy_tree(physeq) <- ape::root(phy=phyloseq::phy_tree(physeq), outgroup="msp_0001_unassigned", resolve.root=TRUE, interactive=FALSE) #outgroup is an eucaryote

save(physeq, file="infraspecies_phyloseq")


physeq2 = phyloseq::phyloseq(physeq@otu_table,physeq@tax_table,physeq@phy_tree)

phyloseq::phy_tree(physeq2) <- ape::root(phy=phyloseq::phy_tree(physeq2), outgroup="msp_0001_unassigned", resolve.root=TRUE, interactive=FALSE) 


infraspecies_unifrac = phyloseq::distance(physeq2, method="unifrac")

save(infraspecies_unifrac, file="infraspecies_unifrac")
load("infraspecies_unifrac")
#infraspecies_jsd_phyloseq = phyloseq::distance(physeq, method="jsd")
# 
# infraspecies %>%
#   select(superkingdom, msp_name_partition) %>%
#   filter(superkingdom == "Eukaryota")
# 



```


## co-inertia analysis


### unifrac infraspecies

```{r}

load(system.file("biom", "food_unifrac.dist", package="IBSFood"))

A = merge(infraspecies_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE),
food_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE) , by=c("item1","item2")) %>%
  reshape2::dcast(item1~item2, value.var = "distance.x") %>% .[,-1] %>%
  as.dist()

B = merge(infraspecies_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE),
food_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE) , by=c("item1","item2")) %>%
  reshape2::dcast(item1~item2, value.var = "distance.y") %>% .[,-1] %>%
  as.dist()


infraspecies_pco = dudi.pco(A %>% ade4::quasieuclid(), scannf = F, nf=10)

food_pco = dudi.pco(B %>% ade4::quasieuclid(), scannf = F, nf=10)


infraspecies_food_coi = coinertia(infraspecies_pco,food_pco, scannf=F, nf=10)


plot(infraspecies_food_coi)


coinertia(dudi.pca(infraspecies_pco$li, scannf=F, nf=10),dudi.pca(food_pco$li, scannf=F, nf=10), scannf=F, nf=3) %>% randtest


cor(infraspecies_food_coi$lX,food_pco$li[1:2]) %>%
  reshape2::melt() %>%
  group_by(Var2) %>%
  top_n(2)



cor(infraspecies_food_coi$lX,infraspecies_pco$li[1:2]) %>%
  reshape2::melt() %>%
  group_by(Var2) %>%
  top_n(2)




```


**distance shuffling**

```{r, eval=FALSE, include=FALSE}

#load(system.file("biom", "food_unifrac.dist", package="IBSFood"))

#set.seed(1)

rv_sim = 1:99

pb <- txtProgressBar(min = 0, max = length(rv_sim), style = 3)
# 
# infraspecies_norm =
# infraspecies %>%
#   mutate_at(vars(contains("M", ignore.case = F)),function(x){x/sum(x)}) %>% 
#   select(contains("M",ignore.case = F))
# 
# infraspecies_norm_names = colnames(infraspecies_norm)
# 
# infraspecies_jsd = BiotypeR::dist.JSD(infraspecies_norm)

for(i in 1:length(rv_sim)) {

#infraspecies_norm = infraspecies_norm %>% apply(.,2, sample) #%>% t  %>% apply(.,2, sample)

#colnames(infraspecies_norm) = infraspecies_norm_names
#rownames(infraspecies_norm) = rownames(infraspecies)
    
#
  
  
  
A = merge(infraspecies_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE),
food_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE) , by=c("item1","item2")) %>%
  reshape2::dcast(item1~item2, value.var = "distance.x") %>% .[,-1] %>%
  as.dist()


attr(A, "Labels") = sample(A %>% attr(., "Labels"))

A = A %>% as.matrix %>% .[order(attr(A, "Labels")),order(attr(A, "Labels"))] %>% as.dist


B = merge(infraspecies_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE),
food_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE) , by=c("item1","item2")) %>%
  reshape2::dcast(item1~item2, value.var = "distance.y") %>% .[,-1] %>%
  as.dist()

attr(B, "Labels") = sample(B %>% attr(., "Labels"))

B =  B %>% as.matrix %>% .[order(attr(B, "Labels")),order(attr(B, "Labels"))] %>% as.dist


infraspecies_unifrac_pco = dudi.pco(A , scannf = F, nf=10)

food_pco = dudi.pco(B %>% ade4::quasieuclid(), scannf = F, nf=10)



infraspecies_unifrac_food_coi = coinertia(infraspecies_unifrac_pco,food_pco, scannf=F, nf=10)


rv_sim[i] = infraspecies_unifrac_food_coi$RV
setTxtProgressBar(pb, i)
}
close(pb)


########## observed ############
# 
# infraspecies_norm =
# infraspecies %>%
#   mutate_at(vars(contains("M", ignore.case = F)),function(x){x/sum(x)}) %>% 
#   select(contains("M",ignore.case = F))
# 
# infraspecies_jsd = BiotypeR::dist.JSD(infraspecies_norm)
# 

A = merge(infraspecies_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE),
food_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE) , by=c("item1","item2")) %>%
  reshape2::dcast(item1~item2, value.var = "distance.x") %>% .[,-1] %>%
  as.dist()


#attr(A, "Labels") = sample(A %>% attr(., "Labels"))

A = A %>% as.matrix %>% .[order(attr(A, "Labels")),order(attr(A, "Labels"))] %>% as.dist


B = merge(infraspecies_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE),
food_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE) , by=c("item1","item2")) %>%
  reshape2::dcast(item1~item2, value.var = "distance.y") %>% .[,-1] %>%
  as.dist()

B =  B %>% as.matrix %>% .[order(attr(B, "Labels")),order(attr(B, "Labels"))] %>% as.dist


infraspecies_unifrac_pco = dudi.pco(A , scannf = F, nf=10)

food_pco = dudi.pco(B %>% ade4::quasieuclid(), scannf = F, nf=10)



infraspecies_unifrac_food_coi = coinertia(infraspecies_unifrac_pco,food_pco, scannf=F, nf=10)


rv_obs = infraspecies_unifrac_food_coi$RV

table(rv_obs >= rv_sim)



#infra_food_pro = procuste(infraspecies_pco$tab, food_pco$tab, scale = FALSE, nf=3)


#randtest(infra_food_pro)



```


### JSD Phylum
```{r}



load(system.file("biom", "food_unifrac.dist", package="IBSFood"))

A = merge(phylum_jsd %>% broom::tidy(diagonal=TRUE, upper=TRUE),
food_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE) , by=c("item1","item2")) %>%
  reshape2::dcast(item1~item2, value.var = "distance.x") %>% .[,-1] %>%
  as.dist()

B = merge(phylum_jsd %>% broom::tidy(diagonal=TRUE, upper=TRUE),
food_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE) , by=c("item1","item2")) %>%
  reshape2::dcast(item1~item2, value.var = "distance.y") %>% .[,-1] %>%
  as.dist()


phylum_pco = dudi.pco(A %>% ade4::quasieuclid(), scannf = F, nf=10)

food_pco = dudi.pco(B %>% ade4::quasieuclid(), scannf = F, nf=10)


phylum_food_coi = coinertia(phylum_pco,food_pco, scannf=F, nf=10)




coinertia(dudi.pca(phylum_pco$li, scannf=F, nf=10),dudi.pca(food_pco$li, scannf=F, nf=10), scannf=F, nf=3) %>% randtest





```






### JSD genus


```{r}


load(system.file("biom", "food_unifrac.dist", package="IBSFood"))

A = merge(genus_jsd %>% broom::tidy(diagonal=TRUE, upper=TRUE),
food_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE) , by=c("item1","item2")) %>%
  reshape2::dcast(item1~item2, value.var = "distance.x") %>% .[,-1] %>%
  as.dist()

B = merge(genus_jsd %>% broom::tidy(diagonal=TRUE, upper=TRUE),
food_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE) , by=c("item1","item2")) %>%
  reshape2::dcast(item1~item2, value.var = "distance.y") %>% .[,-1] %>%
  as.dist()


genus_pco = dudi.pco(A %>% ade4::quasieuclid(), scannf = F, nf=10)

food_pco = dudi.pco(B %>% ade4::quasieuclid(), scannf = F, nf=10)


genus_food_coi = coinertia(genus_pco,food_pco, scannf=F, nf=10)




coinertia(dudi.pca(infraspecies_pco$li, scannf=F, nf=10),dudi.pca(food_pco$li, scannf=F, nf=10), scannf=F, nf=3) %>% randtest





```


**distance shuffling**

```{r, eval=FALSE, include=FALSE}

#load(system.file("biom", "food_unifrac.dist", package="IBSFood"))

#set.seed(1)

rv_sim = 1:99

pb <- txtProgressBar(min = 0, max = length(rv_sim), style = 3)
# 
# infraspecies_norm =
# infraspecies %>%
#   mutate_at(vars(contains("M", ignore.case = F)),function(x){x/sum(x)}) %>% 
#   select(contains("M",ignore.case = F))
# 
# infraspecies_norm_names = colnames(infraspecies_norm)
# 
# infraspecies_jsd = BiotypeR::dist.JSD(infraspecies_norm)

for(i in 1:length(rv_sim)) {

#infraspecies_norm = infraspecies_norm %>% apply(.,2, sample) #%>% t  %>% apply(.,2, sample)

#colnames(infraspecies_norm) = infraspecies_norm_names
#rownames(infraspecies_norm) = rownames(infraspecies)
    
#
  
  
  
A = merge(genus_jsd %>% broom::tidy(diagonal=TRUE, upper=TRUE),
food_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE) , by=c("item1","item2")) %>%
  reshape2::dcast(item1~item2, value.var = "distance.x") %>% .[,-1] %>%
  as.dist()


attr(A, "Labels") = sample(A %>% attr(., "Labels"))

A = A %>% as.matrix %>% .[order(attr(A, "Labels")),order(attr(A, "Labels"))] %>% as.dist


B = merge(genus_jsd %>% broom::tidy(diagonal=TRUE, upper=TRUE),
food_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE) , by=c("item1","item2")) %>%
  reshape2::dcast(item1~item2, value.var = "distance.y") %>% .[,-1] %>%
  as.dist()

attr(B, "Labels") = sample(B %>% attr(., "Labels"))

B =  B %>% as.matrix %>% .[order(attr(B, "Labels")),order(attr(B, "Labels"))] %>% as.dist


genus_pco = dudi.pco(A , scannf = F, nf=10)

food_pco = dudi.pco(B %>% ade4::quasieuclid(), scannf = F, nf=10)



genus_food_coi = coinertia(genus_pco,food_pco, scannf=F, nf=10)


rv_sim[i] = genus_food_coi$RV
setTxtProgressBar(pb, i)
}
close(pb)


########## observed ############
# 
# infraspecies_norm =
# infraspecies %>%
#   mutate_at(vars(contains("M", ignore.case = F)),function(x){x/sum(x)}) %>% 
#   select(contains("M",ignore.case = F))
# 
# infraspecies_jsd = BiotypeR::dist.JSD(infraspecies_norm)
# 

A = merge(genus_jsd %>% broom::tidy(diagonal=TRUE, upper=TRUE),
food_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE) , by=c("item1","item2")) %>%
  reshape2::dcast(item1~item2, value.var = "distance.x") %>% .[,-1] %>%
  as.dist()


#attr(A, "Labels") = sample(A %>% attr(., "Labels"))

A = A %>% as.matrix %>% .[order(attr(A, "Labels")),order(attr(A, "Labels"))] %>% as.dist


B = merge(genus_jsd %>% broom::tidy(diagonal=TRUE, upper=TRUE),
food_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE) , by=c("item1","item2")) %>%
  reshape2::dcast(item1~item2, value.var = "distance.y") %>% .[,-1] %>%
  as.dist()

B =  B %>% as.matrix %>% .[order(attr(B, "Labels")),order(attr(B, "Labels"))] %>% as.dist


genus_pco = dudi.pco(A , scannf = F, nf=10)

food_pco = dudi.pco(B %>% ade4::quasieuclid(), scannf = F, nf=10)



genus_food_coi = coinertia(genus_pco,food_pco, scannf=F, nf=10)


rv_obs = genus_food_coi$RV

table(rv_obs >= rv_sim)



#infra_food_pro = procuste(infraspecies_pco$tab, food_pco$tab, scale = FALSE, nf=3)


#randtest(infra_food_pro)



```





### JSD species

```{r}

load(system.file("biom", "food_unifrac.dist", package="IBSFood"))

A = merge(species_jsd %>% broom::tidy(diagonal=TRUE, upper=TRUE),
food_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE) , by=c("item1","item2")) %>%
  reshape2::dcast(item1~item2, value.var = "distance.x") %>% .[,-1] %>%
  as.dist()

B = merge(species_jsd %>% broom::tidy(diagonal=TRUE, upper=TRUE),
food_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE) , by=c("item1","item2")) %>%
  reshape2::dcast(item1~item2, value.var = "distance.y") %>% .[,-1] %>%
  as.dist()


infraspecies_pco = dudi.pco(A %>% ade4::quasieuclid(), scannf = F, nf=10)

food_pco = dudi.pco(B %>% ade4::quasieuclid(), scannf = F, nf=10)


infraspecies_food_coi = coinertia(infraspecies_pco,food_pco, scannf=F, nf=10)

coinertia(dudi.pca(infraspecies_pco$li, scannf=F, nf=10),dudi.pca(food_pco$li, scannf=F, nf=10), scannf=F, nf=3) %>% randtest


```





### JSD infraspecies

```{r}

load(system.file("biom", "food_unifrac.dist", package="IBSFood"))

A = merge(infraspecies_jsd %>% broom::tidy(diagonal=TRUE, upper=TRUE),
food_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE) , by=c("item1","item2")) %>%
  reshape2::dcast(item1~item2, value.var = "distance.x") %>% .[,-1] %>%
  as.dist()

B = merge(infraspecies_jsd %>% broom::tidy(diagonal=TRUE, upper=TRUE),
food_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE) , by=c("item1","item2")) %>%
  reshape2::dcast(item1~item2, value.var = "distance.y") %>% .[,-1] %>%
  as.dist()


infraspecies_pco = dudi.pco(A %>% ade4::quasieuclid(), scannf = F, nf=10)

food_pco = dudi.pco(B %>% ade4::quasieuclid(), scannf = F, nf=10)


infraspecies_food_coi = coinertia(infraspecies_pco,food_pco, scannf=F, nf=10)

#infraspecies_food_coi = coinertia(dudi.pca(infraspecies_pco$li, scannf=F, nf=10),dudi.pca(food_pco$li, scannf=F, nf=10), scannf=F, nf=10)

coinertia(dudi.pca(infraspecies_pco$li, scannf=F, nf=10),dudi.pca(food_pco$li, scannf=F, nf=10), scannf=F, nf=10) %>% randtest

# 
# cor(
# infraspecies_food_coi$lX,
# infraspecies_food_coi2$lX
# ) %>% abs %>% heatmap
# 

cor(infraspecies_food_coi$lX,food_pco$li[1:3]) %>%
  reshape2::melt() %>%
  group_by(Var2) %>%
  top_n(2)

# 
# 
# cor(infraspecies_food_coi$lX,dudi.pca(food_pco$li, scannf=F, nf=10)$li[1:3]) %>%
#   reshape2::melt() %>%
#   group_by(Var2) %>%
#   top_n(2)
# 



cor(infraspecies_food_coi$lX,infraspecies_pco$li[1:3]) %>%
  reshape2::melt() %>%
  group_by(Var2) %>%
  top_n(2)


# 
# cor(infraspecies_food_coi$lX,dudi.pca(infraspecies_pco$li, scannf=F, nf=10)$li[1:3]) %>%
#   reshape2::melt() %>%
#   group_by(Var2) %>%
#   top_n(2)
# 

#cumsum(infraspecies_pco$eig/sum(infraspecies_pco$eig))
#cumsum(food_pco$eig/sum(food_pco$eig))

plot(infraspecies_food_coi)



cbind(infraspecies_food_coi$lX,food_pco$li[1:3]) %>%
  ggplot() + geom_point(aes(AxcX1,A1),size=5, alpha=0.5, color="white") + 
  ylab("Diet PCo1 (Plant/Meat)") + xlab("Coinertia PC1") + theme_dark()


```




When 10 Principal components are selected for the co-inertia analysis, 
JSD at species and infraspecies levels are significantly associated with food inertia.


**distance shuffling**

```{r, eval=FALSE, include=FALSE}

#load(system.file("biom", "food_unifrac.dist", package="IBSFood"))

#set.seed(1)

rv_sim = 1:999

pb <- txtProgressBar(min = 0, max = length(rv_sim), style = 3)
# 
# infraspecies_norm =
# infraspecies %>%
#   mutate_at(vars(contains("M", ignore.case = F)),function(x){x/sum(x)}) %>% 
#   select(contains("M",ignore.case = F))
# 
# infraspecies_norm_names = colnames(infraspecies_norm)
# 
# infraspecies_jsd = BiotypeR::dist.JSD(infraspecies_norm)

for(i in 1:length(rv_sim)) {

#infraspecies_norm = infraspecies_norm %>% apply(.,2, sample) #%>% t  %>% apply(.,2, sample)

#colnames(infraspecies_norm) = infraspecies_norm_names
#rownames(infraspecies_norm) = rownames(infraspecies)
    
#
  
  
  
A = merge(infraspecies_jsd %>% broom::tidy(diagonal=TRUE, upper=TRUE),
food_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE) , by=c("item1","item2")) %>%
  reshape2::dcast(item1~item2, value.var = "distance.x") %>% .[,-1] %>%
  as.dist()


attr(A, "Labels") = sample(A %>% attr(., "Labels"))

A = A %>% as.matrix %>% .[order(attr(A, "Labels")),order(attr(A, "Labels"))] %>% as.dist


B = merge(infraspecies_jsd %>% broom::tidy(diagonal=TRUE, upper=TRUE),
food_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE) , by=c("item1","item2")) %>%
  reshape2::dcast(item1~item2, value.var = "distance.y") %>% .[,-1] %>%
  as.dist()

attr(B, "Labels") = sample(B %>% attr(., "Labels"))

B =  B %>% as.matrix %>% .[order(attr(B, "Labels")),order(attr(B, "Labels"))] %>% as.dist


infraspecies_pco = dudi.pco(A , scannf = F, nf=10)

food_pco = dudi.pco(B %>% ade4::quasieuclid(), scannf = F, nf=10)



infraspecies_food_coi = coinertia(infraspecies_pco,food_pco, scannf=F, nf=10)


rv_sim[i] = infraspecies_food_coi$RV
setTxtProgressBar(pb, i)
}
close(pb)


########## observed ############
# 
# infraspecies_norm =
# infraspecies %>%
#   mutate_at(vars(contains("M", ignore.case = F)),function(x){x/sum(x)}) %>% 
#   select(contains("M",ignore.case = F))
# 
# infraspecies_jsd = BiotypeR::dist.JSD(infraspecies_norm)
# 

A = merge(infraspecies_jsd %>% broom::tidy(diagonal=TRUE, upper=TRUE),
food_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE) , by=c("item1","item2")) %>%
  reshape2::dcast(item1~item2, value.var = "distance.x") %>% .[,-1] %>%
  as.dist()


#attr(A, "Labels") = sample(A %>% attr(., "Labels"))

A = A %>% as.matrix %>% .[order(attr(A, "Labels")),order(attr(A, "Labels"))] %>% as.dist


B = merge(infraspecies_jsd %>% broom::tidy(diagonal=TRUE, upper=TRUE),
food_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE) , by=c("item1","item2")) %>%
  reshape2::dcast(item1~item2, value.var = "distance.y") %>% .[,-1] %>%
  as.dist()

B =  B %>% as.matrix %>% .[order(attr(B, "Labels")),order(attr(B, "Labels"))] %>% as.dist


infraspecies_pco = dudi.pco(A , scannf = F, nf=10)

food_pco = dudi.pco(B %>% ade4::quasieuclid(), scannf = F, nf=10)



infraspecies_food_coi = coinertia(infraspecies_pco,food_pco, scannf=F, nf=10)


rv_obs = infraspecies_food_coi$RV

table(rv_obs >= rv_sim)



#infra_food_pro = procuste(infraspecies_pco$tab, food_pco$tab, scale = FALSE, nf=3)


#randtest(infra_food_pro)



```





#### partial co-ineria analysis

with unifrac Food and JSD infraspecies


```{r, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}


A = merge(infraspecies_jsd %>% broom::tidy(diagonal=TRUE, upper=TRUE),
food_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE) , by=c("item1","item2")) %>%
  reshape2::dcast(item1~item2, value.var = "distance.x") %>% .[,-1] %>%
  as.dist()

B = merge(infraspecies_jsd %>% broom::tidy(diagonal=TRUE, upper=TRUE),
food_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE) , by=c("item1","item2")) %>%
  reshape2::dcast(item1~item2, value.var = "distance.y") %>% .[,-1] %>%
  as.dist()


infraspecies_pco = dudi.pco(infraspecies_jsd, scannf = F, nf=10)

food_pco = dudi.pco(food_unifrac %>% ade4::quasieuclid(), scannf = F, nf=10)


#infraspecies_food_coi = coinertia(infraspecies_pco,food_pco, scannf=F, nf=10)

samples_intersect = 
intersect(
infraspecies_jsd %>% attr(.,"Labels"),

food_unifrac %>% attr(.,"Labels"))

infraspecies_pco_tabsup = infraspecies_pco$tab[-which(row.names(infraspecies_pco$tab) %in% samples_intersect),]
infraspecies_pco$tab = infraspecies_pco$tab[samples_intersect,]
infraspecies_pco$li = infraspecies_pco$li[samples_intersect,]
infraspecies_pco$l1 = infraspecies_pco$l1[samples_intersect,]

infraspecies_pco$lw = 1/length(samples_intersect)

food_pco_tabsup = food_pco$tab[-which(row.names(food_pco$tab) %in% samples_intersect),]
food_pco$tab = food_pco$tab[samples_intersect,]
food_pco$li = food_pco$li[samples_intersect,]
food_pco$l1 = food_pco$l1[samples_intersect,]

food_pco$lw = 1/length(samples_intersect)

infraspecies_pco
food_pco

infraspecies_food_coi = coinertia(infraspecies_pco,food_pco, scannf=F, nf=10)

infraspecies_food_coi_spesup = ade4::suprow(infraspecies_food_coi,infraspecies_pco_tabsup)
infraspecies_food_coi_foodsup = ade4::supcol(infraspecies_food_coi,t(food_pco_tabsup))

colnames(infraspecies_food_coi_spesup$lisup) = colnames(infraspecies_food_coi$lX)
colnames(infraspecies_food_coi_foodsup$cosup) = colnames(infraspecies_food_coi$lY)


plot(infraspecies_food_coi)

s.label(infraspecies_food_coi$lX)
s.label(infraspecies_food_coi_spesup$lisup,add.p=T,clab=1.5)

s.label(infraspecies_food_coi$lY)
s.label(infraspecies_food_coi_foodsup$cosup,add.p=T,clab=1.5)



rbind(infraspecies_food_coi$lX,infraspecies_food_coi_spesup$lisup)

IBSMicrobiota::IBSData$metadata %>% 
  filter(Visit == "V4", Sample_type =="Stool") %>%
  merge(.,rbind(infraspecies_food_coi$lX,infraspecies_food_coi_spesup$lisup), by.x="Patient_ID", by.y="row.names") %>%
  select(IBS.Severity.Score, contains("AxcX")) %>%
  reshape2::melt(id.vars="IBS.Severity.Score") %>%
  group_by(variable) %>%
  do(w = with(.,cor.test(value,IBS.Severity.Score))) %>% broom::tidy(w)
    
 

rbind(infraspecies_food_coi$lY,infraspecies_food_coi_foodsup$cosup)






```



```{r}

merge(dudi.pco(infraspecies_jsd, scannf = F, nf=10)$li[1:3],
      rbind(infraspecies_food_coi$lX,infraspecies_food_coi_spesup$lisup)[1:3], by="row.names") %>% .[-1] %>%
  cor(method="spearman")


merge(dudi.pco(food_unifrac %>% ade4::quasieuclid(), scannf = F, nf=10)$li[1:3],
      rbind(infraspecies_food_coi$lY,infraspecies_food_coi_foodsup$cosup)[1:3], by="row.names") %>% .[-1] %>%
  cor(method="spearman")
                                                                                                    


```








### compute correlation with co-inertia component





```{r, message=FALSE, warning=FALSE}


rbind(infraspecies_food_coi$lX,infraspecies_food_coi_spesup$lisup) %>% head



infraspecies %>% 
  select(contains("M", ignore.case = F),msp_name_partition) %>%
  mutate_at(vars(contains("M", ignore.case = F)),function(x){x/sum(x)}) %>%
  reshape2::melt(id.vars="msp_name_partition") %>%
  merge(rbind(infraspecies_food_coi$lX,infraspecies_food_coi_spesup$lisup),.,by.x="row.names", by.y="variable") %>%
  group_by(msp_name_partition) %>%
  summarize(A1_cor=cor(AxcX1,value, method="spearman"), 
            A2_cor=cor(AxcX2,value, method="spearman"),
            A3_cor=cor(AxcX3,value, method="spearman"),
            A4_cor=cor(AxcX4,value, method="spearman"),
            A5_cor=cor(AxcX5,value, method="spearman")
            ) %>%
  #filter(abs(A1_cor)> 0.25|abs(A2_cor)> 0.25 ) %>%
  arrange(msp_name_partition) -> infraspecies_coi_cor








```

interaction simple only


```{r, message=FALSE, warning=FALSE}
data("food_data")
data("food_group_levels")

food_data %>%
  merge(food_group_levels, by.x="Code",by.y="Livsmedelsnummer", all = FALSE) %>%
  select(-Foodstuffs.y) %>%
  dplyr::rename(Foodstuffs = Foodstuffs.x) %>%
  group_by(Identity, `Food groups lvl1`, `Food groups lvl2`, `Food groups lvl3`,`Food groups lvl4`) %>%
  summarise(Gram = sum(Gram)) %>%
  na.omit() %>%
  reshape2::dcast(Identity ~ `Food groups lvl4`, value.var = "Gram",fill = 0 ) %>%
    tibble::column_to_rownames("Identity") %>%
  t() %>%
  #as_tibble %>%
  round() -> food_otu

infraspecies_food_coi$lY %>% head


food_otu %>% 
  reshape2::melt() %>%
  #reshape2::melt(id.vars="msp_name_partition") %>%
  merge(rbind(infraspecies_food_coi$lY,infraspecies_food_coi_foodsup$cosup),.,by.x="row.names", by.y="Var2") %>%
  group_by(Var1) %>%
  summarize(A1_cor=cor(AxcY1,value, method="spearman"), 
            A2_cor=cor(AxcY2,value, method="spearman"),
            A3_cor=cor(AxcY3,value, method="spearman"),
            A4_cor=cor(AxcY4,value, method="spearman"),
            A5_cor=cor(AxcY5,value, method="spearman")) %>%
  #filter(abs(A1_cor)> 0.25|abs(A2_cor)> 0.25 ) %>% 
  arrange(A2_cor) -> food_coi_cor




```


```{r}

food_group_levels %>%
  select(-Livsmedelsnamn, -Livsmedelsnummer, -Livsmedelsnamn_eng, -Foodstuffs) %>% 
  unique %>%
  arrange(`Food groups lvl4`)



```

## association with metadata


### permanova



```{r, fig.height=4, fig.width=8}

data("enterotypes")

data("cazotypes")

load(system.file("biom", "food_unifrac.dist", package="IBSFood"))

A = merge(infraspecies_jsd %>% broom::tidy(diagonal=TRUE, upper=TRUE),
food_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE) , by=c("item1","item2")) %>%
  reshape2::dcast(item1~item2, value.var = "distance.x") %>% .[,-1] %>%
  as.dist()

A_phylum = merge(phylum_jsd %>% broom::tidy(diagonal=TRUE, upper=TRUE),
food_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE) , by=c("item1","item2")) %>%
  reshape2::dcast(item1~item2, value.var = "distance.x") %>% .[,-1] %>%
  as.dist()

A_genus = merge(genus_jsd %>% broom::tidy(diagonal=TRUE, upper=TRUE),
food_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE) , by=c("item1","item2")) %>%
  reshape2::dcast(item1~item2, value.var = "distance.x") %>% .[,-1] %>%
  as.dist()

A_species = merge(species_jsd %>% broom::tidy(diagonal=TRUE, upper=TRUE),
food_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE) , by=c("item1","item2")) %>%
  reshape2::dcast(item1~item2, value.var = "distance.x") %>% .[,-1] %>%
  as.dist()

A_unifrac = merge(infraspecies_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE),
food_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE) , by=c("item1","item2")) %>%
  reshape2::dcast(item1~item2, value.var = "distance.x") %>% .[,-1] %>%
  as.dist()

B = merge(infraspecies_jsd %>% broom::tidy(diagonal=TRUE, upper=TRUE),
food_unifrac %>% broom::tidy(diagonal=TRUE, upper=TRUE) , by=c("item1","item2")) %>%
  reshape2::dcast(item1~item2, value.var = "distance.y") %>% .[,-1] %>%
  as.dist()


et_grp = 
  merge(attr(A,"Label") %>% 
      as.matrix %>% as.data.frame, 
    enterotypes %>% 
      filter(Visit=="V4"), by.x="V1", by.y="Patient_ID", all=FALSE)  %>% 
  merge(.,cazotypes, by.x="V1",by.y="row.names") %>%
  merge(.,
    IBSMicrobiota::IBSData$metadata %>%
      filter(Visit=="V4", Sample_type =="Stool") %>%
      select(Gender,Health,Patient_ID, IBS.Severity.Score, SSgroup,H2_group,CH4_group), by.x="V1", by.y="Patient_ID", all.x=TRUE ) %>%
  mutate(enterotypes = enterotypes %>% as.character, 
    cazotype = cazotype %>% as.character) %>% 
  mutate(SS= ifelse(SSgroup=="severe","severe","non-severe")) %>% 
  mutate(SS = ifelse(is.na(SS),"non-severe",SS)) %>%
  mutate(H2_group = ifelse(is.na(H2_group),"low",H2_group)) %>%
  mutate(CH4_group = ifelse(is.na(CH4_group),"low",CH4_group)) %>%
  tibble::column_to_rownames("V1")



```



```{r, eval=FALSE, include=FALSE}


#warning : label order for adonis

vegan::adonis(B %>% ade4::quasieuclid() ~ cazotype , data=et_grp[attr(B,"Label"),] ) %>% class
vegan::adonis(A  ~ cazotype , data=et_grp[attr(A,"Label"),] )

vegan::adonis(B %>% ade4::quasieuclid() ~ enterotypes , data=et_grp[attr(B,"Label"),] )
vegan::adonis(A  ~ enterotypes , data=et_grp[attr(A,"Label"),] )

vegan::adonis(B %>% ade4::quasieuclid() ~ Health , data=et_grp[attr(B,"Label"),] )
vegan::adonis(A  ~ Health  , data=et_grp[attr(A,"Label"),] )


vegan::adonis(B %>% ade4::quasieuclid() ~ Gender , data=et_grp[attr(B,"Label"),] )
vegan::adonis(A  ~ Gender , data=et_grp[attr(A,"Label"),] )


vegan::adonis(B %>% ade4::quasieuclid()  ~ Gender * Health * cazotype , data=et_grp[attr(B,"Label"),] )

vegan::adonis(A  ~ Gender * Health * cazotype , data=et_grp[attr(A,"Label"),] )

vegan::adonis2(B %>% ade4::quasieuclid()  ~ Gender * Health * enterotypes * cazotype , data=et_grp[attr(B,"Label"),] , by="terms")

vegan::adonis2(B %>% ade4::quasieuclid()  ~ Gender * Health * enterotypes * cazotype , data=et_grp[attr(B,"Label"),] , by=NULL)

## test by each taxo ranl

vegan::adonis2(A_unifrac  ~ Gender * Health * enterotypes * cazotype * H2_group * CH4_group , data=et_grp[attr(A_unifrac,"Label"),], by="terms" ) %>% broom::tidy()

vegan::adonis2(A_phylum  ~ Gender * Health * enterotypes * cazotype * H2_group * CH4_group, data=et_grp[attr(A_phylum,"Label"),], by="terms" ) %>% broom::tidy()
vegan::adonis2(A_genus  ~ Gender * Health * enterotypes * cazotype * H2_group * CH4_group, data=et_grp[attr(A_genus,"Label"),], by="terms" ) %>% broom::tidy()
vegan::adonis2(A_species  ~ Gender * Health * enterotypes * cazotype * H2_group * CH4_group, data=et_grp[attr(A_species,"Label"),], by="terms" ) %>% broom::tidy()
vegan::adonis2(A  ~ Gender * Health * enterotypes * cazotype * H2_group * CH4_group, data=et_grp[attr(A,"Label"),], by="terms" ) %>% broom::tidy()


# same with Gender blocked permutation

set.seed(222)
perm <- permute::how(nperm = 999)

permute::setBlocks(perm) <- with(et_grp[attr(A_unifrac,"Label"),], Gender)
vegan::adonis2(A_unifrac  ~ Health * SS * enterotypes * cazotype * H2_group * CH4_group, data=et_grp[attr(A_unifrac,"Label"),], by="terms", permutations = perm ) %>% broom::tidy()

rbind(
permute::setBlocks(perm) <- with(et_grp[attr(A_phylum,"Label"),], Gender),
vegan::adonis2(A_phylum  ~ Health * SS * enterotypes * cazotype * H2_group * CH4_group, data=et_grp[attr(A_phylum,"Label"),], by="terms", permutations = perm  ) %>% broom::tidy() %>% mutate(tax="01_phylum"),

permute::setBlocks(perm) <- with(et_grp[attr(A_genus,"Label"),], Gender),
vegan::adonis2(A_genus  ~ Health * SS * enterotypes * cazotype * H2_group * CH4_group, data=et_grp[attr(A_genus,"Label"),], by="terms", permutations = perm  ) %>% broom::tidy() %>% mutate(tax="02_genus"),

permute::setBlocks(perm) <- with(et_grp[attr(A_species,"Label"),], Gender),
vegan::adonis2(A_species  ~ Health * SS * enterotypes * cazotype * H2_group * CH4_group, data=et_grp[attr(A_species,"Label"),], by="terms", permutations = perm  ) %>% broom::tidy() %>% mutate(tax="03_species"),

permute::setBlocks(perm) <- with(et_grp[attr(A,"Label"),], Gender),
vegan::adonis2(A  ~ Health * SS * enterotypes * cazotype * H2_group * CH4_group, data=et_grp[attr(A,"Label"),], by="terms", permutations = perm  ) %>% broom::tidy() %>% mutate(tax="04_infraspecies")
) -> jsd_permanova

jsd_permanova %>%
  filter(term %in% c("Health","SS","enterotypes","cazotype","H2_group","CH4_group")) %>%
  select(term,R2,p.value,tax) %>%
  dplyr::rename(p_value = p.value) %>%
  ggplot() + 
  geom_bar(aes(y=R2,x=tax, fill=p_value <=0.05 ), stat="identity") + 
  facet_wrap(~term) + scale_y_continuous(labels = scales::percent) +
  coord_flip() + guides(fill=FALSE)

ggsave("jsd_permanova.pdf",h=4,w=8)

permute::setBlocks(perm) <- with(et_grp[attr(B,"Label"),], Gender)
vegan::adonis2(B  ~ Health * SS * enterotypes * cazotype * H2_group * CH4_group, data=et_grp[attr(B,"Label"),], by="terms", permutations = perm  ) %>% broom::tidy()

vegan::adonis2(B  ~ Health *  enterotypes * cazotype , data=et_grp[attr(B,"Label"),], by=NULL, permutations = perm  ) %>% broom::tidy()



perm <- permute::how(nperm = 999)
#vegan::adonis2(A  ~ Health * enterotypes * cazotype , data=et_grp[attr(A,"Label"),])
vegan::adonis2(A  ~ Health * enterotypes * cazotype , data=et_grp[attr(A,"Label"),], permutations = perm)
permute::setBlocks(perm) <- with(et_grp[attr(A,"Label"),], Gender)
vegan::adonis2(A  ~ Health * enterotypes * cazotype , data=et_grp[attr(A,"Label"),], permutations = perm)
vegan::adonis2(B %>% ade4::quasieuclid()  ~ Health * enterotypes * cazotype , data=et_grp[attr(B,"Label"),] ,  permutations = perm)


     dudi.pco(A,scannf=F, nf=3) %>% .$li %>% merge(.,et_grp, by="row.names") %>%  ggplot() + geom_point(aes(x=A1,y=A2,col=enterotypes %>% as.character))

     dudi.pco(B %>% ade4::quasieuclid(),scannf=F, nf=3) %>% .$li %>% merge(.,et_grp, by="row.names") %>%  ggplot() + geom_point(aes(x=A1,y=A2,col=cazotype %>% as.character))
     
     dudi.pco(B %>% ade4::quasieuclid(),scannf=F, nf=3) %>% .$li %>% merge(.,et_grp, by="row.names") %>%  ggplot() + geom_point(aes(x=A1,y=A2,col=enterotypes %>% as.character))
```

#### simple permanova without interaction

```{r, message=FALSE, warning=FALSE}

set.seed(222)
vegan::adonis(B %>% ade4::quasieuclid() ~ Gender , data=et_grp[attr(B,"Label"),], by="terms" ) %>% .$aov.tab %>%  broom::tidy()

set.seed(222)
vegan::adonis(B %>% ade4::quasieuclid() ~ Health , data=et_grp[attr(B,"Label"),], by="terms" ) %>% .$aov.tab %>% broom::tidy()

set.seed(222)
vegan::adonis(B %>% ade4::quasieuclid() ~ cazotype , data=et_grp[attr(B,"Label"),], by="terms" ) %>% .$aov.tab %>%  broom::tidy()

set.seed(222)
vegan::adonis(B %>% ade4::quasieuclid() ~ enterotypes , data=et_grp[attr(B,"Label"),], by="terms" ) %>% .$aov.tab %>% broom::tidy()

set.seed(222)
vegan::adonis2(B %>% ade4::quasieuclid() ~ Gender + Health + cazotype + enterotypes , data=et_grp[attr(B,"Label"),], by="margin" ) %>% broom::tidy()



```


```{r}

set.seed(222)
perm <- permute::how(nperm = 999)

#permute::setBlocks(perm) <- with(et_grp[attr(A_unifrac,"Label"),], Gender)

#vegan::adonis2(A_unifrac  ~ Health * SS * enterotypes * cazotype * H2_group * CH4_group, data=et_grp[attr(A_unifrac,"Label"),], by="terms", permutations = perm ) %>% broom::tidy()

rbind(

vegan::adonis2(A_phylum  ~ Gender + Health + SS + enterotypes + cazotype + H2_group + CH4_group, data=et_grp[attr(A_phylum,"Label"),], by="margin", permutations = perm  ) %>% broom::tidy() %>% mutate(tax="01_phylum"),


vegan::adonis2(A_genus  ~ Gender + Health + SS + enterotypes + cazotype + H2_group + CH4_group, data=et_grp[attr(A_genus,"Label"),], by="margin", permutations = perm  ) %>% broom::tidy() %>% mutate(tax="02_genus"),


vegan::adonis2(A_species  ~ Gender + Health + SS + enterotypes + cazotype + H2_group + CH4_group, data=et_grp[attr(A_species,"Label"),], by="margin", permutations = perm  ) %>% broom::tidy() %>% mutate(tax="03_species"),


vegan::adonis2(A  ~ Gender + Health + SS + enterotypes + cazotype + H2_group + CH4_group, data=et_grp[attr(A,"Label"),], by="margin", permutations = perm  ) %>% broom::tidy() %>% mutate(tax="04_infraspecies")
) -> jsd_permanova

jsd_permanova %>%
  filter(term %in% c("Gender","Health","SS","enterotypes","cazotype","H2_group","CH4_group")) %>%
  select(term,R2,p.value,tax) %>%
  dplyr::rename(p_value = p.value) %>%
  ggplot() + 
  geom_bar(aes(y=R2,x=tax, fill=p_value <=0.05 ), stat="identity") + 
  facet_wrap(~term) + scale_y_continuous(labels = scales::percent) +
  coord_flip() + guides(fill=FALSE)


jsd_permanova %>%
  filter(term %in% c("Gender","Health","SS","enterotypes","cazotype","H2_group","CH4_group")) %>%
  select(term,R2,p.value,tax) %>%
  dplyr::rename(p_value = p.value) %>%
  ggplot() + geom_bar(aes(y=R2,x=tax, fill=term ), stat="identity") + scale_fill_brewer("",type = "qual") + ylab("% variance explained") + xlab("Microbiota taxonomics levels")


```


### between within analysis cazotypes

```{r, message=FALSE}

B %>% 
  broom::tidy() %>%
  merge(.,et_grp, by.x="item1", by.y="row.names") %>%
  merge(.,et_grp, by.x="item2", by.y="row.names") %>%
  mutate(group = ifelse(cazotype.x == cazotype.y, "within","between")) %>%
  group_by(cazotype.x) %>%
  do(w=with(.,t.test(distance~group))) %>% broom::tidy(w)


B %>% 
  broom::tidy() %>%
  merge(.,et_grp, by.x="item1", by.y="row.names") %>%
  merge(.,et_grp, by.x="item2", by.y="row.names") %>%
  mutate(group = ifelse(cazotype.x == cazotype.y, "within","between")) %>%
  ggplot() + 
  #geom_violin(aes(y=distance,x=cazotype.x,fill=group))
  geom_interval(data= . %>% group_by(cazotype.x,group) %>% tidybayes::mean_qi(distance=distance , .prob = c(.5, .66, .95, .99)) , aes(x=paste(cazotype.x,group), y=distance)) +
  #geom_jitter(aes(x=Gender, y=A1), width=0.1) +
  geom_point(data = . %>% group_by(cazotype.x,group) %>% summarize(distance=median(distance)), aes(x=paste(cazotype.x,group), y=distance) , size=5, shape=18  ) + 
  scale_color_brewer("c.i.") +
  facet_wrap(~paste("cazotype",cazotype.x),nrow = 1, scale="free_x") +
  xlab("")

ggsave("diet_between_within_cazotypes.pdf")


B %>% 
  broom::tidy() %>%
  merge(.,et_grp, by.x="item1", by.y="row.names") %>%
  merge(.,et_grp, by.x="item2", by.y="row.names") %>%
  mutate(group = ifelse(enterotypes.x == enterotypes.y, "within","between")) %>%
  group_by(enterotypes.x) %>%
  do(w=with(.,t.test(distance~group))) %>% broom::tidy(w)


B %>% 
  broom::tidy() %>%
  merge(.,et_grp, by.x="item1", by.y="row.names") %>%
  merge(.,et_grp, by.x="item2", by.y="row.names") %>%
  mutate(group = ifelse(enterotypes.x == enterotypes.y, "within","between")) %>%
  ggplot() + geom_violin(aes(y=distance,x=enterotypes.x,fill=group))
  


```


### co-inertia plot

```{r}

scatter(food_pco) %>% unclass

food_pco$li

infraspecies_food_coi$aX
infraspecies_food_coi$aY

infraspecies_food_coi


cor(food_pco$li,infraspecies_food_coi$lY) %>% melt %>% group_by(Var2) %>% arrange(Var2,desc(value)) %>% top_n(3)



infraspecies_food_coi


```


```{r}

ggplot() + 
  geom_segment(data= merge(infraspecies_food_coi$lX,infraspecies_food_coi$lY, by="row.names"), aes(x=AxcX1,y=AxcX2,xend=AxcY1,yend=AxcY2),col="grey") +
  geom_point(data = rbind(infraspecies_food_coi$lX,infraspecies_food_coi_spesup$lisup), aes(AxcX1,AxcX2), col="lightblue") +
  geom_point(data = rbind(infraspecies_food_coi$lY,infraspecies_food_coi_foodsup$cosup), aes(AxcY1,AxcY2), col="pink") +
  xlab("Co-inertia axis 1") + ylab("Co-inertia axis 2")
  
ggsave("coinertia_subject.pdf")

## to do: compute euclidean distance between diet and microbiota within co-inertia and bootstrap

```

```{r, fig.height=2, fig.width=3}

ggplot() + 
  geom_segment(data= merge(infraspecies_food_coi$lX,infraspecies_food_coi$lY, by="row.names"), aes(x=AxcX1,y=AxcX2,xend=AxcY1,yend=AxcY2),col="grey") +
  geom_point(data = rbind(infraspecies_food_coi$lX,infraspecies_food_coi_spesup$lisup), aes(AxcX1,AxcX2), col="lightblue") +
  geom_point(data = rbind(infraspecies_food_coi$lY,infraspecies_food_coi_foodsup$cosup), aes(AxcY1,AxcY2), col="pink") +
  xlab("Co-inertia axis 1") + ylab("Co-inertia axis 2")


ggplot() + 
  geom_point(data = rbind(infraspecies_food_coi$lX,infraspecies_food_coi_spesup$lisup), aes(AxcX1,AxcX2), col="lightblue")  +
  xlab("Co-inertia axis 1") + ylab("Co-inertia axis 2")

ggplot() + 
   geom_point(data = rbind(infraspecies_food_coi$lY,infraspecies_food_coi_foodsup$cosup), aes(AxcY1,AxcY2), col="pink") +
  xlab("Co-inertia axis 1") + ylab("Co-inertia axis 2")


```


```{r}

ggplot() + 
  geom_segment(data= merge(infraspecies_food_coi$lX,infraspecies_food_coi$lY, by="row.names"), aes(x=AxcX1,y=AxcX5,xend=AxcY1,yend=AxcY5),col="grey") +
  geom_point(data = rbind(infraspecies_food_coi$lX,infraspecies_food_coi_spesup$lisup), aes(AxcX1,AxcX5), col="lightblue") +
  geom_point(data = rbind(infraspecies_food_coi$lY,infraspecies_food_coi_foodsup$cosup), aes(AxcY1,AxcY5), col="pink") +
  xlab("Co-inertia axis 1") + ylab("Co-inertia axis 5")
  
ggsave("coinertia_subject_nutriscore_Ax5.pdf")




```


### coinertia axis and metadata

```{r, message=FALSE, warning=FALSE}



rbind(infraspecies_food_coi$lX,infraspecies_food_coi_spesup$lisup)[1:5] %>%
  merge(.,IBSMicrobiota::IBSData$metadata %>%
          filter(Visit=="V4",Sample_type=="Stool"), by.x="row.names", by.y="Patient_ID") %>%
  select_if(is.numeric) %>%
  mutate(H2_CH4 = H2/(CH4+1)) %>%
  reshape2::melt(id.vars=c("AxcX1","AxcX2","AxcX3","AxcX4","AxcX5")) %>%
  group_by(variable) %>%
  na.omit() %>%
  
  summarise(A1_cor =  cor(AxcX1, value, method = "spearman")     %>% round(2),
            A1_p   =  cor.test(AxcX1, value, method = "spearman")$p.value %>% round(2),
            
            A2_cor =  cor(AxcX2, value, method = "spearman")     %>% round(2),
            A2_p   =  cor.test(AxcX2, value, method = "spearman")$p.value %>% round(2),
            A3_cor=  cor(AxcX3, value, method = "spearman")     %>% round(2),
            A3_p   =  cor.test(AxcX3, value, method = "spearman")$p.value %>% round(2),
            A4_cor=  cor(AxcX4, value, method = "spearman")     %>% round(2),
            A4_p   =  cor.test(AxcX4, value, method = "spearman")$p.value %>% round(2),
            A5_cor=  cor(AxcX5, value, method = "spearman")     %>% round(2),
            A5_p   =  cor.test(AxcX5, value, method = "spearman")$p.value %>% round(2),
            n=n())

rbind(infraspecies_food_coi$lY,infraspecies_food_coi_foodsup$cosup)[1:5] %>%
  merge(.,IBSMicrobiota::IBSData$metadata %>%
          filter(Visit=="V4",Sample_type=="Stool"), by.x="row.names", by.y="Patient_ID") %>%
  select_if(is.numeric) %>%
  mutate(H2_CH4 = H2/(CH4+1)) %>%
  reshape2::melt(id.vars=c("AxcY1","AxcY2","AxcY3","AxcY4","AxcY5")) %>%
  group_by(variable) %>%
  na.omit() %>%
  
  summarise(A1_cor =  cor(AxcY1, value, method = "spearman")     %>% round(2),
            A1_p   =  cor.test(AxcY1, value, method = "spearman")$p.value %>% round(2),
            
            A2_cor =  cor(AxcY2, value, method = "spearman")     %>% round(2),
            A2_p   =  cor.test(AxcY2, value, method = "spearman")$p.value %>% round(2),
            A3_cor=  cor(AxcY3, value, method = "spearman")     %>% round(2),
            A3_p   =  cor.test(AxcY3, value, method = "spearman")$p.value %>% round(2),
            A4_cor=  cor(AxcY4, value, method = "spearman")     %>% round(2),
            A4_p   =  cor.test(AxcY4, value, method = "spearman")$p.value %>% round(2),
            A5_cor=  cor(AxcY5, value, method = "spearman")     %>% round(2),
            A5_p   =  cor.test(AxcY5, value, method = "spearman")$p.value %>% round(2),
            n=n())


# 
# infraspecies_food_coi$lX[1:3] %>%
#   merge(.,IBSMicrobiota::IBSData$metadata %>%
#           filter(Visit=="V4",Sample_type=="Stool"), by.x="row.names", by.y="Patient_ID") %>%
#   mutate(breath_H2 = ifelse(H2>5,"High_H2","Low_H2"), breath_CH4 = ifelse(H2>5,"High_CH4","Low_CH4")) %>%
#   ggplot() + geom_point(aes( y=AxcX3, x=(H2+1)/(CH4+1) %>% log2))  + geom_smooth(aes( y=AxcX3, x=(H2+1)/(CH4+1) %>% log2), method = "lm")
# 



rbind(infraspecies_food_coi$lX,infraspecies_food_coi_spesup$lisup)[1:5] %>%
  merge(.,IBSMicrobiota::IBSData$metadata %>%
          filter(Visit=="V4",Sample_type=="Stool"), by.x="row.names", by.y="Patient_ID") %>%
  mutate(breath_H2 = ifelse(H2>10,"High_H2","Low_H2"), breath_CH4 = ifelse(CH4>10,"High_CH4","Low_CH4")) %>%
  mutate(CH4_H2 = (CH4+1)/(H2+1)) %>%
  ggplot() + geom_point(aes( y=AxcX5, x=CH4_H2)) + coord_flip() + geom_smooth(aes( y=AxcX5, x=CH4_H2))


  rbind(infraspecies_food_coi$lY,infraspecies_food_coi_foodsup$cosup)[1:5] %>%
  merge(.,IBSMicrobiota::IBSData$metadata %>%
          filter(Visit=="V4",Sample_type=="Stool"), by.x="row.names", by.y="Patient_ID") %>%
  mutate(breath_H2 = ifelse(H2>10,"High_H2","Low_H2"), breath_CH4 = ifelse(CH4>10,"High_CH4","Low_CH4")) %>%
  mutate(CH4_H2 = (CH4+1)/(H2+1)) %>%
  ggplot() + geom_point(aes( y=AxcY5, x=CH4_H2)) + coord_flip() + geom_smooth(aes( y=AxcY5, x=CH4_H2))


rbind(infraspecies_food_coi$lX,infraspecies_food_coi_spesup$lisup)[1:5] %>%
  merge(.,IBSMicrobiota::IBSData$metadata %>%
          filter(Visit=="V4",Sample_type=="Stool"), by.x="row.names", by.y="Patient_ID") %>%
  mutate(breath_H2 = ifelse(H2>10,"High_H2","Low_H2"), breath_CH4 = ifelse(CH4>10,"High_CH4","Low_CH4")) %>%
  ggplot() + geom_boxplot(aes( y=AxcX3, x=paste(breath_H2,breath_CH4))) + coord_flip()



rbind(infraspecies_food_coi$lX,infraspecies_food_coi_spesup$lisup)[1:5] %>%
  merge(.,IBSMicrobiota::IBSData$metadata %>%
          filter(Visit=="V4",Sample_type=="Stool"), by.x="row.names", by.y="Patient_ID") %>%
  mutate(breath_H2 = ifelse(H2>10,"High_H2","Low_H2"), breath_CH4 = ifelse(CH4>10,"High_CH4","Low_CH4")) %>%
  ggplot() + geom_boxplot(aes( y=AxcX2, x=paste(breath_H2,breath_CH4))) + coord_flip()



rbind(infraspecies_food_coi$lX,infraspecies_food_coi_spesup$lisup)[1:5] %>%
  merge(.,IBSMicrobiota::IBSData$metadata %>%
          filter(Visit=="V4",Sample_type=="Stool"), by.x="row.names", by.y="Patient_ID") %>%
  mutate(breath_H2 = ifelse(H2>10,"High_H2","Low_H2"), breath_CH4 = ifelse(CH4>10,"High_CH4","Low_CH4")) %>%
  ggplot() + geom_boxplot(aes( y=AxcX1, x=paste(breath_H2,breath_CH4))) + coord_flip()

## enterotypes
data("enterotypes")



rbind(infraspecies_food_coi$lX,infraspecies_food_coi_spesup$lisup)[1:5] %>%
  merge(.,IBSMicrobiota::IBSData$metadata %>%
          filter(Visit=="V4",Sample_type=="Stool"), by.x="row.names", by.y="Patient_ID") %>%
  merge(.,enterotypes, by.x="Row.names", by.y="Patient_ID") %>%
  mutate(enterotypes = enterotypes %>% as.character) %>%
  ggplot() + geom_jitter(aes(x=enterotypes,y=AxcX3))


rbind(infraspecies_food_coi$lX,infraspecies_food_coi_spesup$lisup)[1:5] %>%
  merge(.,IBSMicrobiota::IBSData$metadata %>%
          filter(Visit=="V4",Sample_type=="Stool"), by.x="row.names", by.y="Patient_ID") %>%
  merge(.,enterotypes, by.x="Row.names", by.y="Patient_ID") %>%
  mutate(enterotypes = enterotypes %>% as.character) %>%
  ggplot() + geom_jitter(aes(x=enterotypes,y=AxcX2))


rbind(infraspecies_food_coi$lX,infraspecies_food_coi_spesup$lisup)[1:5] %>%
  merge(.,IBSMicrobiota::IBSData$metadata %>%
          filter(Visit=="V4",Sample_type=="Stool"), by.x="row.names", by.y="Patient_ID") %>%
  merge(.,enterotypes, by.x="Row.names", by.y="Patient_ID") %>%
  mutate(enterotypes = enterotypes %>% as.character) %>%
  ggplot() + geom_jitter(aes(x=enterotypes,y=AxcX1))


## cazotype

rbind(infraspecies_food_coi$lX,infraspecies_food_coi_spesup$lisup)[1:5] %>%
  merge(.,IBSMicrobiota::IBSData$metadata %>%
          filter(Visit=="V4",Sample_type=="Stool"), by.x="row.names", by.y="Patient_ID") %>%
  merge(.,cazotypes, by.x="Row.names", by.y="row.names") %>%
  mutate(cazotype = cazotype %>% as.character) %>%
  ggplot() + geom_jitter(aes(x=cazotype,y=AxcX3))

rbind(infraspecies_food_coi$lX,infraspecies_food_coi_spesup$lisup)[1:5] %>%
  merge(.,IBSMicrobiota::IBSData$metadata %>%
          filter(Visit=="V4",Sample_type=="Stool"), by.x="row.names", by.y="Patient_ID") %>%
  merge(.,cazotypes, by.x="Row.names", by.y="row.names") %>%
  mutate(cazotype = cazotype %>% as.character) %>%
  ggplot() + geom_jitter(aes(x=cazotype,y=AxcX2))

rbind(infraspecies_food_coi$lX,infraspecies_food_coi_spesup$lisup)[1:5] %>%
  merge(.,IBSMicrobiota::IBSData$metadata %>%
          filter(Visit=="V4",Sample_type=="Stool"), by.x="row.names", by.y="Patient_ID") %>%
  merge(.,cazotypes, by.x="Row.names", by.y="row.names") %>%
  mutate(cazotype = cazotype %>% as.character) %>%
  ggplot() + geom_boxplot(aes(x=cazotype,y=AxcX1))


rbind(infraspecies_food_coi$lX,infraspecies_food_coi_spesup$lisup)[1:5] %>%
  merge(.,IBSMicrobiota::IBSData$metadata %>%
          filter(Visit=="V4",Sample_type=="Stool"), by.x="row.names", by.y="Patient_ID") %>%
  merge(.,enterotypes, by.x="Row.names", by.y="Patient_ID") %>%
  mutate(enterotypes = enterotypes %>% as.character) %>%
  mutate(breath_H2 = ifelse(H2>10,"High_H2","Low_H2"), breath_CH4 = ifelse(CH4>10,"High_CH4","Low_CH4")) %>%
  xtabs( ~ enterotypes + paste(breath_H2,breath_CH4), data=.) %>% prop.table(1)

#cazotypes = read.csv2("data-raw/cazotypes.csv", row.names = 1)

merge(enterotypes %>% filter(Visit=="V4"), cazotypes, by.x="Patient_ID", by.y="row.names") %>%
xtabs( ~ enterotypes + cazotype, data=.)


rbind(infraspecies_food_coi$lX,infraspecies_food_coi_spesup$lisup)[1:5] %>%
  merge(.,IBSMicrobiota::IBSData$metadata %>%
          filter(Visit=="V4",Sample_type=="Stool"), by.x="row.names", by.y="Patient_ID") %>%
  merge(.,cazotypes, by.x="Row.names", by.y="row.names") %>%
  mutate(cazotype = cazotype %>% as.character) %>%
  mutate(breath_H2 = ifelse(H2>10,"High_H2","Low_H2"), breath_CH4 = ifelse(CH4>10,"High_CH4","Low_CH4")) %>%
  xtabs( ~ cazotype + paste(breath_H2,breath_CH4), data=.) %>% prop.table(1)

#to do: predict H2/CH4 from diet or microbiota

```


### principal component regression

The goal is to predict exhaled gas based on diet and microbiota co-inertia component

#### microbiota gas prediction
```{r}

#infraspecies_food_coi$lX => microbiota
#infraspecies_food_coi$lY => food

# infraspecies_food_coi_spesup => microbiota sup
#infraspecies_food_coi_foodsup => food sup

#


rbind(cbind(group="train",infraspecies_food_coi$lX),cbind(group="test",infraspecies_food_coi_spesup$lisup))[1:6] %>%
  merge(.,IBSMicrobiota::IBSData$metadata %>%
          filter(Visit=="V4",Sample_type=="Stool"), by.x="row.names", by.y="Patient_ID") %>%
  #select_if(is.numeric) %>%
  mutate(H2_CH4 = log2((H2+1)/(CH4+1))) %>%
  #mutate(H2_CH4 = H2+1) %>%
  select(Row.names,group,AxcX1,AxcX2,AxcX3,AxcX4,AxcX5,H2_CH4) -> microbiota_data_gas

  


microbiota_data_gas %>%
  filter(group=="train") %>%
  select(AxcX1,AxcX2,AxcX3,AxcX4,AxcX5,H2_CH4) %>%
  with(
    ., lm(H2_CH4~., data=.)
  ) -> microbiota_model

microbiota_model

gas_microbiota_predict = 
  predict(microbiota_model, 
        microbiota_data_gas %>% 
          filter(group=="test") %>%
          select(AxcX1,AxcX2,AxcX3,AxcX4,AxcX5,H2_CH4))

cbind(predicted_gas=gas_microbiota_predict,observed_gas=microbiota_data_gas %>% filter(group=="test") %>% .$H2_CH4) %>% na.omit %>% as.data.frame %>%
  ggplot(aes(x=observed_gas %>% as.character %>% as.numeric , y=predicted_gas %>% as.character %>% as.numeric )) + 
  geom_point() + geom_smooth(method="lm") + 
  ylab("predicted exaled\nH2/CH4 ratio (log2)") + xlab("observed exaled\nH2/CH4 ratio (log2)") #+ 
  #scale_x_continuous(trans="log2") + scale_y_continuous(trans="log2") + 
  #xlim(0,8) + ylim(0,8)




```

#### gas prediction from food based on microbiota model

```{r}


rbind(cbind(group="train",infraspecies_food_coi$lY),cbind(group="test",infraspecies_food_coi_foodsup$cosup))[1:10] %>%
  merge(.,IBSMicrobiota::IBSData$metadata %>%
          filter(Visit=="V4",Sample_type=="Stool"), by.x="row.names", by.y="Patient_ID") %>%
  #select_if(is.numeric) %>%
  mutate(H2_CH4 = log2((H2+1)/(CH4+1))) %>%
  #mutate(H2_CH4 = H2+1) %>%
  select(Row.names,group,AxcY1,AxcY2,AxcY3,AxcY4,AxcY5,AxcY6,AxcY7,AxcY8,AxcY9,H2_CH4) -> food_data_gas


food_data_gas %>%
  filter(group=="train") %>%
  select(AxcY1,AxcY2,AxcY3,AxcY4,AxcY5,H2_CH4) %>%
  with(
    ., lm(H2_CH4~., data=.)
  ) -> food_model

food_model


gas_food_predict = 
  predict(microbiota_model, 
        food_data_gas %>% 
          filter(group=="test") %>%
          select(AxcY1,AxcY2,AxcY3,AxcY4,AxcY5,H2_CH4) %>%
          dplyr::rename(AxcX1=AxcY1,AxcX2=AxcY2,AxcX3=AxcY3,AxcX4=AxcY4,AxcX5=AxcY5))



cbind(predicted_gas=gas_predict,observed_gas=food_data_gas %>% filter(group=="test") %>% .$H2_CH4) %>% na.omit %>% as.data.frame %>%
  filter(predicted_gas < 0.25 & observed_gas > -2) %>%
  ggplot(aes(x=observed_gas %>% as.character %>% as.numeric , y=predicted_gas %>% as.character %>% as.numeric )) + 
  geom_point() + geom_smooth(method="lm") + 
  ylab("predicted exaled\nH2/CH4 ratio (log2)") + xlab("observed exaled\nH2/CH4 ratio (log2)") #+ 
  #scale_x_continuous(trans="log2") + scale_y_continuous(trans="log2") + 
  #xlim(0,8) + ylim(0,8)

cbind(predicted_gas=gas_food_predict,observed_gas=food_data_gas %>% filter(group=="test") %>% .$H2_CH4) %>% na.omit %>% as.data.frame %>%
  filter(predicted_gas < 0.25 & observed_gas > -2) %>%
  with(.,cor.test(.$predicted_gas, .$observed_gas, method="pearson"))


cbind(predicted_gas=gas_food_predict,observed_gas=food_data_gas %>% filter(group=="test") %>% .$H2_CH4, Patient_ID=food_data_gas %>% filter(group=="test") %>% .["Row.names"]) %>% na.omit %>% as.data.frame %>%
  filter(predicted_gas > 0.25 & observed_gas < -2)





```


```{r}

IBSMicrobiota::IBSData$metadata %>% 
  filter(Visit=="V4",Sample_type=="Stool") %>%
  filter(Patient_ID %in% c("M162","M195","M226"))
  
  
IBSMicrobiota::IBSData$metadata %>% 
  filter(Visit=="V4",Sample_type=="Stool") %>%
  select(Patient_ID,BSF.Mean_Stoolform_total,BSF.Mean_Frequenc_StoolPerDay,transit.days) %>%
  ggplot() + geom_text(aes(x=transit.days, y=BSF.Mean_Frequenc_StoolPerDay, label=Patient_ID), size=2)
  
  
  

```


```{r, fig.height=2, fig.width=2}

rbind(

cbind(predicted_gas=gas_food_predict,observed_gas=food_data_gas %>% filter(group=="test") %>% .$H2_CH4, Patient_ID=food_data_gas %>% filter(group=="test") %>% .["Row.names"]) %>% na.omit %>% as.data.frame %>%
  filter(predicted_gas < 0.25 & observed_gas > -2),


cbind(predicted_gas=gas_microbiota_predict,observed_gas=microbiota_data_gas %>% filter(group=="test") %>% .$H2_CH4, Patient_ID=microbiota_data_gas %>% filter(group=="test") %>% .["Row.names"]) %>% na.omit %>% as.data.frame ) %>%
  ggplot(aes(x=observed_gas %>% as.character %>% as.numeric %>% scale() , y=predicted_gas %>% as.character %>% as.numeric %>% scale() )) +
  geom_point() + geom_smooth(method="lm") + 
  ylab("predicted gas") + xlab("observed gas")
  

cbind(predicted_gas=gas_microbiota_predict,observed_gas=microbiota_data_gas %>% filter(group=="test") %>% .$H2_CH4, Patient_ID=microbiota_data_gas %>% filter(group=="test") %>% .["Row.names"]) %>% na.omit %>% as.data.frame  %>%
  with(.,cor.test(.$predicted_gas, .$observed_gas, method="spearman"))


```



## visualisations

```{r}

infraspecies_coi_cor %>%
  merge(.,infraspecies %>% select(-contains("M",ignore.case = F)), by="msp_name_partition") %>%
  #filter(abs(A1_cor)>0.35|abs(A2_cor)>0.35) %>% 
  arrange(A1_cor)


infraspecies_coi_cor %>%
  merge(.,infraspecies %>% select(-contains("M",ignore.case = F)), by="msp_name_partition") %>%
  filter(abs(A1_cor)>0.3|abs(A2_cor)>0.3) %>%
  ggplot() + ggrepel::geom_label_repel(aes(x=A1_cor, y=A2_cor, label=genus), size=2, label.size = NA, fill=NA)

ggsave("co-inertia_drivers_genus.pdf")


infraspecies_coi_cor %>%
  merge(.,infraspecies %>% select(-contains("M",ignore.case = F)), by="msp_name_partition") %>%
  filter(abs(A1_cor)>0.3|abs(A2_cor)>0.3) %>%
  ggplot() + ggrepel::geom_label_repel(aes(x=A1_cor, y=A2_cor, label=msp_name_partition), size=2, label.size = NA, fill=NA)


ggsave("co-inertia_drivers_infraspecies.pdf")


infraspecies_coi_cor %>%
  merge(.,infraspecies %>% select(-contains("M",ignore.case = F)), by="msp_name_partition") %>%
  filter(abs(A1_cor)>0.3|abs(A3_cor)>0.3) %>%
  ggplot() + ggrepel::geom_label_repel(aes(x=A1_cor, y=A3_cor, label=genus), size=2, label.size = NA, fill=NA)


ggsave("co-inertia_drivers_genus_ax3.pdf")


infraspecies_coi_cor %>%
  merge(.,infraspecies %>% select(-contains("M",ignore.case = F)), by="msp_name_partition") %>%
  filter(abs(A1_cor)>0.3|abs(A3_cor)>0.3) %>%
  ggplot() + ggrepel::geom_label_repel(aes(x=A1_cor, y=A3_cor, label=msp_name_partition), size=2, label.size = NA, fill=NA)


ggsave("co-inertia_drivers_infraspecies_ax3.pdf")



infraspecies_coi_cor %>%
  merge(.,infraspecies %>% select(-contains("M",ignore.case = F)), by="msp_name_partition") %>%
  filter(abs(A1_cor)>0.3|abs(A4_cor)>0.3) %>%
  ggplot() + ggrepel::geom_label_repel(aes(x=A1_cor, y=A4_cor, label=genus), size=2, label.size = NA, fill=NA)


ggsave("co-inertia_drivers_genus_ax4.pdf")


infraspecies_coi_cor %>%
  merge(.,infraspecies %>% select(-contains("M",ignore.case = F)), by="msp_name_partition") %>%
  filter(abs(A1_cor)>0.3|abs(A4_cor)>0.3) %>%
  ggplot() + ggrepel::geom_label_repel(aes(x=A1_cor, y=A4_cor, label=msp_name_partition), size=2, label.size = NA, fill=NA)


ggsave("co-inertia_drivers_infraspecies_ax4.pdf")


infraspecies_coi_cor %>%
  merge(.,infraspecies %>% select(-contains("M",ignore.case = F)), by="msp_name_partition") %>%
  filter(abs(A1_cor)>0.3|abs(A5_cor)>0.3) %>%
  ggplot() + ggrepel::geom_label_repel(aes(x=A1_cor, y=A5_cor, label=genus), size=2, label.size = NA, fill=NA)


ggsave("co-inertia_drivers_genus_ax5.pdf")


infraspecies_coi_cor %>%
  merge(.,infraspecies %>% select(-contains("M",ignore.case = F)), by="msp_name_partition") %>%
  filter(abs(A1_cor)>0.3|abs(A5_cor)>0.3) %>%
  ggplot() + ggrepel::geom_label_repel(aes(x=A1_cor, y=A5_cor, label=msp_name_partition), size=2, label.size = NA, fill=NA)


ggsave("co-inertia_drivers_infraspecies_ax5.pdf")

```


```{r, message=FALSE, warning=FALSE}



data("nutriscore_food_group")


food_coi_cor %>%
  merge(.,nutriscore_food_group, by.y="Food groups lvl4", by.x="Var1") %>%
  select(A1_cor,A2_cor,A3_cor,nutriscore,cor_A1,cor_A2) %>%
  ggplot() + 
  geom_point(aes(x=A1_cor,y=A2_cor,col=nutriscore), size=3, alpha=0.75) +
  xlab("association with Coi1") + ylab("association with Coi2")
  #+ viridis::scale_color_viridis(option = "magma")
  
ggsave("coinertia_nutriscore.pdf")
  



food_coi_cor %>%
  merge(.,nutriscore_food_group, by.y="Food groups lvl4", by.x="Var1") %>%
  select(A1_cor,A2_cor,A3_cor,nutriscore,cor_A1,cor_A2) %>%
  ggplot() + 
  geom_point(aes(x=A1_cor,y=A3_cor,col=nutriscore), size=3, alpha=0.75) +
  xlab("association with Coi1") + ylab("association with Coi3")
  #+ viridis::scale_color_viridis(option = "magma")
  
ggsave("coinertia_nutriscore_ax3.pdf")
  



food_coi_cor %>%
  merge(.,nutriscore_food_group, by.y="Food groups lvl4", by.x="Var1") %>%
  select(A1_cor,A2_cor,A3_cor,A4_cor,A5_cor,nutriscore,cor_A1,cor_A2) %>%
  ggplot() + 
  geom_point(aes(x=A4_cor,y=A5_cor,col=nutriscore), size=3, alpha=0.75) +
  xlab("association with Coi4") + ylab("association with Coi5")
  #+ viridis::scale_color_viridis(option = "magma")
  
ggsave("coinertia_nutriscore_ax5.pdf")




food_coi_cor %>%
  merge(.,nutriscore_food_group, by.y="Food groups lvl4", by.x="Var1") %>%
  #merge(food_group_levels %>%
  #select(-Livsmedelsnamn, -Livsmedelsnummer, -Livsmedelsnamn_eng, -Foodstuffs) %>% 
  #  filter(used == "yes") %>%  
  #unique %>%
  #arrange(`Food groups lvl4`), by.x="Var1", by.y="Food groups lvl4") %>%
  unique() %>%
  filter(abs(A1_cor)>0.3|abs(A2_cor)>0.3|abs(A3_cor)>0.3) %>% arrange(A3_cor) %>%
  ggplot() + ggrepel::geom_label_repel(aes(x=A1_cor, y=A2_cor, label=`Food groups lvl3`, color=nutriscore), size=2, label.size = NA, fill=NA) +
  xlab("association with Coi1") + ylab("association with Coi2")

ggsave("co_inertia_food.pdf")




food_coi_cor %>%
  merge(.,nutriscore_food_group, by.y="Food groups lvl4", by.x="Var1") %>%
  #merge(food_group_levels %>%
  #select(-Livsmedelsnamn, -Livsmedelsnummer, -Livsmedelsnamn_eng, -Foodstuffs) %>% 
  #  filter(used == "yes") %>%  
  #unique %>%
  #arrange(`Food groups lvl4`), by.x="Var1", by.y="Food groups lvl4") %>%
  unique() %>%
  filter(abs(A1_cor)>0.3|abs(A2_cor)>0.3|abs(A3_cor)>0.3) %>% arrange(A3_cor) %>%
  ggplot() + ggrepel::geom_label_repel(aes(x=A1_cor, y=A3_cor, label=`Food groups lvl3`, color=nutriscore), size=2, label.size = NA, fill=NA) +
  xlab("association with Coi1") + ylab("association with Coi3")

ggsave("co_inertia_food_ax3.pdf")


food_coi_cor %>%
  merge(.,nutriscore_food_group, by.y="Food groups lvl4", by.x="Var1") %>%
  #merge(food_group_levels %>%
  #select(-Livsmedelsnamn, -Livsmedelsnummer, -Livsmedelsnamn_eng, -Foodstuffs) %>% 
  #  filter(used == "yes") %>%  
  #unique %>%
  #arrange(`Food groups lvl4`), by.x="Var1", by.y="Food groups lvl4") %>%
  unique() %>%
  filter(abs(A1_cor)>0.3|abs(A2_cor)>0.3|abs(A4_cor)>0.3) %>% arrange(A4_cor) %>%
  ggplot() + ggrepel::geom_label_repel(aes(x=A1_cor, y=A4_cor, label=`Food groups lvl3`, color=nutriscore), size=2, label.size = NA, fill=NA) +
  xlab("association with Coi1") + ylab("association with Coi4")

ggsave("co_inertia_food_ax4.pdf")

food_coi_cor %>%
  merge(.,nutriscore_food_group, by.y="Food groups lvl4", by.x="Var1") %>%
  #merge(food_group_levels %>%
  #select(-Livsmedelsnamn, -Livsmedelsnummer, -Livsmedelsnamn_eng, -Foodstuffs) %>% 
  #  filter(used == "yes") %>%  
  #unique %>%
  #arrange(`Food groups lvl4`), by.x="Var1", by.y="Food groups lvl4") %>%
  unique() %>%
  filter(abs(A1_cor)>0.3|abs(A5_cor)>0.3) %>% arrange(A5_cor) %>%
  ggplot() + ggrepel::geom_label_repel(aes(x=A1_cor, y=A5_cor, label=`Food groups lvl3`, color=nutriscore), size=2, label.size = NA, fill=NA) +
  xlab("association with Coi1") + ylab("association with Coi5")



ggsave("co_inertia_food_ax5.pdf")

food_coi_cor %>%
  merge(.,nutriscore_food_group, by.y="Food groups lvl4", by.x="Var1") %>%
  #merge(food_group_levels %>%
  #select(-Livsmedelsnamn, -Livsmedelsnummer, -Livsmedelsnamn_eng, -Foodstuffs) %>% 
  #  filter(used == "yes") %>%  
  #unique %>%
  #arrange(`Food groups lvl4`), by.x="Var1", by.y="Food groups lvl4") %>%
  unique() %>%
  filter(abs(A1_cor)>0.3|abs(A5_cor)>0.3) %>% arrange(A5_cor) %>%
  ggplot() + ggrepel::geom_label_repel(aes(x=A1_cor, y=A5_cor, label=Var1, color=nutriscore), size=2, label.size = NA, fill=NA) +
  xlab("association with Coi1") + ylab("association with Coi5")


food_coi_cor %>%
  merge(.,nutriscore_food_group, by.y="Food groups lvl4", by.x="Var1") %>%
  #merge(food_group_levels %>%
  #select(-Livsmedelsnamn, -Livsmedelsnummer, -Livsmedelsnamn_eng, -Foodstuffs) %>% 
  #  filter(used == "yes") %>%  
  #unique %>%
  #arrange(`Food groups lvl4`), by.x="Var1", by.y="Food groups lvl4") %>%
  unique() %>%
  filter(abs(A1_cor)>0.3|abs(A2_cor)>0.3|abs(A3_cor)>0.3) %>% arrange(A3_cor) %>%
  ggplot() + ggrepel::geom_label_repel(aes(x=A1_cor, y=A2_cor, label=Var1, color=nutriscore), size=2, label.size = NA, fill=NA)




food_coi_cor %>%
merge(.,nutriscore_food_group, by.y="Food groups lvl4", by.x="Var1") %>%
select(A1_cor,A2_cor,A3_cor,A5_cor,nutriscore,cor_A1,cor_A2) %>%
  reshape2::melt(id.vars="nutriscore") %>%
  group_by(variable) %>%
  do(w = with(.,cor.test(nutriscore,value, p.adjust="none", method="spearman"))) %>% broom::tidy(w)



```

```{r}
food_group_levels %>% filter(`Food groups lvl4` == "17_1")

```


hypothesis : if do not eat enough fiber then you lose fiber degrading bactering and only galactose degrading bacteria remains with possibly lactose intolerance due to colic fermentation.

Test the link between PCoA1_Diet and Co_Inertia axis, if the correlation is significant then compared MSP_core and MSP_infraspecies with Nutriscore and Meat_plant_ratio


## Association with meat plant ratio

```{r, message=FALSE, warning=FALSE}


infraspecies %>%
  select(msp_name_partition, msp_name, contains("M", ignore.case = FALSE)) %>%
  reshape2::melt(id.vars=c("msp_name_partition","msp_name")) %>%
  merge(.,meat_plant_ratio, by="variable") %>%
  group_by(msp_name) %>%
  do(w = with(.,pairwise.wilcox.test(meat_plant_ratio,msp_name_partition, p.adjust="none")))  -> test_meat_plant

test_meat_plant %>% arrange(p.value)
 
# 
# 
# infraspecies %>%
#   select(msp_name_partition, msp_name, contains("M", ignore.case = FALSE)) %>%
#   reshape2::melt(id.vars=c("msp_name_partition","msp_name")) %>%
#    group_by(msp_name, variable) %>%
#   summarise(value=sum(value)) %>%
#   ungroup() %>%
#   merge(.,meat_plant_ratio, by="variable") %>%
#   group_by(msp_name) %>%
#   do(w = with(.,cor.test(Dairy,value, method="spearman"))) %>% broom::tidy(w) -> test_meat_plant
#  
# test_meat_plant %>% arrange(p.value)
# 


infraspecies %>%
  select(msp_name_partition, msp_name, contains("M", ignore.case = FALSE)) %>%
  reshape2::melt(id.vars=c("msp_name_partition","msp_name")) %>%
  merge(.,meat_plant_ratio, by="variable") %>%
  group_by(msp_name_partition) %>%
  do(w = with(.,cor.test(meat_plant_ratio,value, method="spearman"))) %>% broom::tidy(w) -> test_meat_plant

test_meat_plant %>% ungroup() %>% 
  mutate(fdr= p.adjust(p.value, method="fdr")) %>% 
  arrange(p.value)




#lapply(test_meat_plant$w, function(x){a=x$p.value %>% as.vector %>% .[1]; if(is.null(a)){a<-"no"};a  }) %>% unlist
#test_meat_plant$w[[48]]$p.value[1]

infraspecies %>% 
  reshape2::melt(id.vars=c("msp_name_partition","msp_name","species","genus","family","order","class","phylum","superkingdom")) %>%
  group_by(variable) %>%
  mutate(prop=value/sum(value)) %>% 
  ungroup %>%
  group_by(msp_name) %>%
  filter(any(prop>0.01)) %>%
  ungroup %>%
  #group_by(variable) %>%
  #summarize(sum=sum(prop))
  dcast(msp_name_partition + msp_name + species + genus + family + order + class + phylum + superkingdom ~ variable) %>%
  .$msp_name_partition %>% length
  


```


## meat plant vs enterotypes vs cazotypes
```{r}

merge(meat_plant_ratio, by.x="variable",
  enterotypes, by.y="Patient_ID") %>%
  ggplot() + geom_boxplot(aes(x=enterotypes %>% as.character,y=meat_plant_ratio))



merge(meat_plant_ratio, by.x="variable",
  enterotypes, by.y="Patient_ID") %>%
  select(meat_plant_ratio, enterotypes) %>%
  reshape2::melt(id.vars="enterotypes") %>%
  group_by(variable) %>%
  do(w = with(.,pairwise.wilcox.test(value,enterotypes, p.adjust="fdr"))) %>% broom::tidy(w)



merge(meat_plant_ratio, by.x="variable",
  cazotypes, by.y="row.names") %>%
  merge(., by.x="variable",
  enterotypes, by.y="Patient_ID") %>%
  ggplot() + geom_boxplot(aes(x=as.character(cazotype),y=meat_plant_ratio))



merge(meat_plant_ratio, by.x="variable",
  cazotypes, by.y="row.names") %>%
  merge(., by.x="variable",
  enterotypes, by.y="Patient_ID") %>%
  select(meat_plant_ratio, cazotype) %>%
  reshape2::melt(id.vars="cazotype") %>%
  group_by(variable) %>%
  do(w = with(.,pairwise.wilcox.test(value,cazotype, p.adjust="fdr"))) %>% broom::tidy(w)


merge(meat_plant_ratio, by.x="variable",
  cazotypes, by.y="row.names") %>%
  merge(., by.x="variable",
  enterotypes, by.y="Patient_ID") %>%
  xtabs( ~ enterotypes + cazotype, data=.) %>% chisq.test()


```





## global heatmap




```{r}
cowplot::plot_grid(
enterotypes %>%
  filter(Visit=="V4") %>%
  merge(.,cazotypes, by.x="Patient_ID", by.y="row.names") %>%
  arrange(enterotypes) %>%
  ggplot() + 
  geom_tile(aes(x = rep("ET",length(enterotypes)), y=1:length(enterotypes),  fill=enterotypes %>% as.character)) + 
  scale_fill_brewer(type="qual", palette = "Set1") +
  #geom_tile(aes(x = rep("Visit",length(enterotypes)), y=1:length(enterotypes),  fill=Visit %>% as.character)) +
  #geom_tile(aes(x = rep("cazotypes",length(enterotypes)), y=1:length(enterotypes),  fill=cazotype %>% as.character)) +
  coord_flip() + theme_minimal() + xlab("") + ylab("") + guides(fill=FALSE),

enterotypes %>%
  filter(Visit=="V4") %>%
  merge(.,cazotypes, by.x="Patient_ID", by.y="row.names") %>%
  arrange(enterotypes) %>%
  ggplot() + 
  #geom_tile(aes(x = rep("ET",length(enterotypes)), y=1:length(enterotypes),  fill=enterotypes %>% as.character)) + 
  scale_fill_brewer(type="qual", palette = "Set2") +
  #geom_tile(aes(x = rep("Visit",length(enterotypes)), y=1:length(enterotypes),  fill=Visit %>% as.character)) +
  geom_tile(aes(x = rep("cazotypes",length(enterotypes)), y=1:length(enterotypes),  fill=cazotype %>% as.character)) +
  coord_flip() + theme_minimal() + xlab("") + ylab("") + guides(fill=FALSE),

nrow=2,
align = "v"

)


```



prepare data for all the map

```{r, fig.height=8, fig.width=4}


df_bar_data =

meat_plant_ratio %>%
merge( infraspecies %>% 
  filter(msp_name == "msp_0070") %>%
  select(msp_name_partition,contains("M", ignore.case = FALSE)) %>%
  as.data.frame() %>%
  tibble::column_to_rownames("msp_name_partition") %>%
  t %>%
  as.data.frame(), by.x="variable",by.y="row.names", all=TRUE) %>%
  merge(enterotypes %>% filter(Visit == "V4" ), by.x="variable",by.y="Patient_ID", all=TRUE) %>%
  merge(cazotypes, by.x="variable", by.y="row.names",  all=TRUE) %>%
  merge(rbind(infraspecies_food_coi$lX,infraspecies_food_coi_spesup$lisup), by.x="variable", by.y="row.names",  all = TRUE) %>%
  arrange(meat_plant_ratio) %>%
  mutate(enterotypes = paste0("ET",enterotypes), cazotype = paste0("CT",cazotype)) %>%
  mutate(Diet_A1_rank = rank(A1))


cowplot::plot_grid(

df_bar_data %>%
  filter(!is.na(meat_plant_ratio)) %>%
  ggplot() + 
  geom_tile(aes(y=1:length(meat_plant_ratio), x=rep("meat\n\\plant",length(meat_plant_ratio)), fill=meat_plant_ratio)) +
  coord_flip() +
  viridis::scale_fill_viridis() +
  theme_minimal() +
  xlab("") + ylab("") +
  guides(fill=FALSE),



df_bar_data %>%
  filter(!is.na(meat_plant_ratio)) %>%
  ggplot() + 
  geom_tile(aes(y=1:length(meat_plant_ratio), x=rep("Diet PCoA1",length(meat_plant_ratio)), fill=A1)) +
  coord_flip() +
  viridis::scale_fill_viridis() +
  theme_minimal() +
  xlab("") + ylab("") +
  guides(fill=FALSE),


df_bar_data %>%
  filter(!is.na(meat_plant_ratio)) %>%
  select(Diet_A1_rank,A1,AxcX1, enterotypes, cazotype) %>%
  GGally::ggparcoord(columns = 3:1, groupColumn = 5, showPoints=TRUE) + coord_flip() + theme_minimal() + xlab("") + ylab("") + scale_color_brewer(type="qual") + guides(color=FALSE),


df_bar_data %>%
  filter(!is.na(AxcX1)) %>%
  arrange(AxcX1) %>%  
  ggplot() + 
  geom_tile(aes(y=1:length(enterotypes), x=rep("ET",length(enterotypes)), fill=enterotypes)) +
  coord_flip() +
  scale_fill_brewer(type="qual") +
  theme_minimal() +
  xlab("") + ylab("") +
  guides(fill=FALSE),



df_bar_data %>%
  filter(!is.na(AxcX1)) %>%
  arrange(AxcX1) %>% 
  ggplot() + 
  geom_tile(aes(y=1:length(enterotypes), x=rep("cazy",length(enterotypes)), fill=cazotype)) +
  coord_flip() +
  scale_fill_brewer(type="qual") +
  theme_minimal() +
  xlab("") + ylab("") +
  guides(fill=FALSE),


df_bar_data %>%
  filter(!is.na(AxcX1)) %>%
  arrange(AxcX1) %>% 
  ggplot() + 
  geom_tile(aes(y=1:length(enterotypes), x=rep("cl1",length(enterotypes)), fill=msp_0070_cl_1)) +
  coord_flip() +
  viridis::scale_fill_viridis() +
  theme_minimal() +
  xlab("") + ylab("") +
  guides(fill=FALSE),


df_bar_data %>%
  filter(!is.na(AxcX1)) %>%
  arrange(AxcX1) %>% 
  ggplot() + 
  geom_tile(aes(y=1:length(enterotypes), x=rep("cl2",length(enterotypes)), fill=msp_0070_cl_2)) +
  coord_flip() +
  viridis::scale_fill_viridis() +
  theme_minimal() +
  xlab("") + ylab("") +
  guides(fill=FALSE),

ncol=1, align = "v", rel_heights = c(1,1,4,1,1,1,1)

)

df_bar_data %>% ggplot() + geom_point(aes(x=A1,y=AxcX1,color=msp_0070_cl_1/(msp_0070_cl_2+10^-6))) + viridis::scale_color_viridis()

df_bar_data %>% ggplot() + geom_point(aes(x=A1,y=AxcX1,color=cazotype))


```




