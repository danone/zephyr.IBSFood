---
title: "Hydrolases analysis"
output: html_notebook
---



```{r}

devtools::load_all()

library(IBSMicrobiota)
library(dplyr)
library(ggplot2)

data("hydrolase_hit")
data("MSP_genes_id_corresp")
data("MSP_tax")
data("IBSData")

```



```{r}

hydrolase_hit %>%
  merge(MSP_genes_id_corresp %>% 
          select(msp_name,module_name,gene_name_v2), 
        by.x="subject id", by.y="gene_name_v2") %>% 
  merge(MSP_tax, by.x="msp_name", by.y="MSP_ID")


```


```{r}

hydrolase_hit %>%
  merge(MSP_genes_id_corresp %>% 
          select(msp_name,module_name,gene_name_v2), 
        by.x="subject id", by.y="gene_name_v2") %>% 
  merge(MSP_tax, by.x="msp_name", by.y="MSP_ID") %>%
  select(Organism,species,phylum,family, `New Class`) %>%
  with(., xtabs(~`New Class`+phylum)) %>%
  heatmap()



```



```{r}


hydrolase_hit %>%
  merge(MSP_genes_id_corresp %>% 
          select(msp_name,module_name,gene_name_v2), 
        by.x="subject id", by.y="gene_name_v2") %>% 
  merge(MSP_tax, by.x="msp_name", by.y="MSP_ID") %>%
  merge(counts_rescaled, by.x="subject id", by.y="genes.id") -> hydrolase_count_rescaled


save(hydrolase_count_rescaled, file="hydrolase_count_rescaled.rda")


```




```{r}

hydrolase_count_rescaled %>%
  group_by(`New Class`) %>%
  summarise_at(vars(contains("M",ignore.case = FALSE)), sum) %>%
  reshape2::melt() %>%
  merge(total_reads %>% as.matrix %>% as.data.frame(), by.x="variable",by.y="row.names") %>%
  mutate(value=value/V1) %>%
  
  reshape2::dcast(variable~`New Class`, value.var="value") %>%
  #mutate_at(vars(contains("M",ignore.case = FALSE)), function(x){x/sum(x)}  ) %>%
  #as.data.frame() %>%
  #tibble::column_to_rownames("New Class") %>%
  tibble::column_to_rownames("variable") %>%
  as.matrix() %>% t %>% na.omit %>% t %>%
  heatmap()


```


```{r}

hydrolase_count_rescaled %>%
  group_by(`New Class`) %>%
  summarise_at(vars(contains("M",ignore.case = FALSE)), sum) %>%
  reshape2::melt() %>%
  merge(total_reads %>% as.matrix %>% as.data.frame(), by.x="variable",by.y="row.names") %>%
  mutate(value=value/V1) %>%
  merge(
    IBSData$metadata %>%
  filter(Visit=="V4", Sample_type=="Stool"),
  by.y="Patient_ID",
  by.x="variable"
    
  ) %>%
  merge(enterotypes %>% filter(Visit=="V4"), by.x="variable", by.y="Patient_ID") %>%
  
ggplot() + geom_boxplot(aes(y=value+10^-6,x=enterotypes %>% as.character)) + facet_wrap(~`New Class`, scales="free_y") 



hydrolase_count_rescaled %>%
  group_by(`New Class`) %>%
  summarise_at(vars(contains("M",ignore.case = FALSE)), sum) %>%
  mutate_at(vars(contains("M",ignore.case = FALSE)), function(x){x/sum(x)}  ) %>%
  #as.data.frame() %>%
  #tibble::column_to_rownames("New Class") %>%

  reshape2::melt(id.vars="New Class") %>%
  merge(
    IBSData$metadata %>%
  filter(Visit=="V4", Sample_type=="Stool"),
  by.y="Patient_ID",
  by.x="variable"
    
  ) %>%
  merge(enterotypes %>% filter(Visit=="V4"), by.x="variable", by.y="Patient_ID") %>%
  filter(!is.na(value)) %>%
  filter(!is.na(SSgroup)) %>%
  ggplot() + geom_boxplot(aes(y=value+10^-6,x=SSgroup)) + facet_wrap(~`New Class`, scales="free_y") + scale_y_log10()


hydrolase_count_rescaled %>%
  group_by(`New Class`) %>%
  summarise_at(vars(contains("M",ignore.case = FALSE)), sum) %>%
  mutate_at(vars(contains("M",ignore.case = FALSE)), function(x){x/sum(x)}  ) %>%
  #as.data.frame() %>%
  #tibble::column_to_rownames("New Class") %>%

  reshape2::melt(id.vars="New Class") %>%
  merge(
    IBSData$metadata %>%
  filter(Visit=="V4", Sample_type=="Stool"),
  by.y="Patient_ID",
  by.x="variable"
    
  ) %>%
  merge(enterotypes %>% filter(Visit=="V4"), by.x="variable", by.y="Patient_ID") %>%
  filter(!is.na(value)) %>%
  group_by(`New Class`) %>%
  do(with(.,wilcox.test(data=., .$value~ .$CH4>10)%>%broom::tidy()))


```



```{r}


hydrolase_count_rescaled %>%
  group_by(`New Class`) %>%
  summarise_at(vars(contains("M",ignore.case = FALSE)), sum) %>%
  mutate_at(vars(contains("M",ignore.case = FALSE)), function(x){x/sum(x)}  ) %>%
  as.data.frame() %>%
  tibble::column_to_rownames("New Class") %>%
  t %>%
  na.omit() %>%
  add(10^-6) %>%
  log10() %>%
  ade4::dudi.pca(scannf=F, nf=10) -> hydrogene_pca


hydrogene_pca$li %>%
  merge(enterotypes %>% filter(Visit=="V4"), by.x="row.names", by.y="Patient_ID") %>%
  merge(
    IBSData$metadata %>%
  filter(Visit=="V4", Sample_type=="Stool"),
  by.y="Patient_ID",
  by.x="Row.names"
    
  ) %>%
  ggplot()+geom_point(aes(x=Axis1, y=Axis3, size=(CH4+1)/(H2+1)))


hydrogene_pca$li %>%
  merge(enterotypes %>% filter(Visit=="V4"), by.x="row.names", by.y="Patient_ID") %>%
  merge(
    IBSData$metadata %>%
  filter(Visit=="V4", Sample_type=="Stool"),
  by.y="Patient_ID",
  by.x="Row.names"
    
  ) %>%
  ggplot()+geom_boxplot(aes(x=Health, y=Axis3))




hydrogene_pca$li %>%
  merge(enterotypes %>% filter(Visit=="V4"), by.x="row.names", by.y="Patient_ID") %>%
  merge(
    IBSData$metadata %>%
  filter(Visit=="V4", Sample_type=="Stool"),
  by.y="Patient_ID",
  by.x="Row.names"
    
  ) %>% 
    with(.,cor.test(data=., .$Axis3, .$SSgroup %>% as.numeric, method="spearman"))


hydrogene_pca$li %>%
  merge(enterotypes %>% filter(Visit=="V4"), by.x="row.names", by.y="Patient_ID") %>%
  merge(
    IBSData$metadata %>%
  filter(Visit=="V4", Sample_type=="Stool"),
  by.y="Patient_ID",
  by.x="Row.names"
    
  ) %>% 
  select(Row.names, contains("Axis"),H2,CH4) %>%
  reshape2::melt(id.vars=c("Row.names","H2","CH4")) %>%
  group_by(variable) %>%
  do(with(.,wilcox.test(data=., .$value~ .$H2>10)%>%broom::tidy()))


  


  
  ade4::s.label(hydrogene_pca$co, yax=3, xax=1)
  


```


Axis 1 = associated with low H2 and High CH4 and with slower transit
Axis 2 = associated with CH4
Axis 3 = associated with severity


```{r}


hydrolase_count_rescaled %>%
  group_by(`New Class`) %>%
  summarise_at(vars(contains("M",ignore.case = FALSE)), sum) %>%
  mutate_at(vars(contains("M",ignore.case = FALSE)), function(x){x/sum(x)}  ) %>%
  as.data.frame() %>%
  reshape2::melt(id.vars=c("New Class")) %>%
merge(
    IBSData$metadata %>%
  filter(Visit=="V4", Sample_type=="Stool") %>% select(Patient_ID,SSgroup),
  by.y="Patient_ID",
  by.x="variable"
    
  )


hydrolase_count_rescaled %>%
  group_by(`New Class`) %>%
  summarise_at(vars(contains("M",ignore.case = FALSE)), sum) %>%
  mutate_at(vars(contains("M",ignore.case = FALSE)), function(x){x/sum(x)}  ) %>%
  as.data.frame() %>%
  filter(`New Class` %in% c("[FeFe] Group A1","[FeFe] Group A3")) %>%
  tibble::column_to_rownames("New Class") %>%
  t %>%
  as.data.frame() %>%
  tibble::rownames_to_column("Patient_ID") %>%
  mutate(A1_A3 = `[FeFe] Group A1` /  `[FeFe] Group A3`) %>%
  merge(
    IBSData$metadata %>%
  filter(Visit=="V4", Sample_type=="Stool") %>% select(Patient_ID,SSgroup, `IBS.Severity.Score`),
  by="Patient_ID"
    
  ) %>%
  na.omit() %>%
  with(.,pairwise.wilcox.test(g=SSgroup, x=A1_A3, p.adjust.method = "none"))

  





```


```{r}

load("hydrolase_count_rescaled.rda")



cazy_counts = read.csv2("cazy_counts.csv", row.names = 1) 

hydrolase_count_rescaled %>% 
  ungroup() %>%
  group_by(`New Class`) %>%
  select(contains("M", ignore.case = FALSE)) %>%
  summarise_all(sum) %>%
  reshape2::melt(id.vars="New Class") %>%
  merge(total_reads %>% as.matrix %>% as.data.frame, by.y="row.names", by.x="variable") %>%
  mutate(value=value/V1) %>%
  reshape2::dcast(`New Class`~variable, value.var = "value") -> hydrogenase_normalized
  



cazy_counts %>% 
  reshape2::melt(id.vars="cazy.family") %>%
  merge(total_reads %>% as.matrix %>% as.data.frame, by.y="row.names", by.x="variable") %>%
  mutate(value=value/V1) %>%
  reshape2::dcast(`cazy.family`~variable, value.var = "value") -> cazy_normalized






```



```{r fig.height=10, fig.width=10}

hydrogenase_normalized %>% 
  dplyr::rename(cazy.family = `New Class`) %>%
  rbind(cazy_normalized) %>%
  tibble::column_to_rownames("cazy.family") %>%
  t() %>%
  cor(method="spearman") %>%
  reshape2::melt() %>%
  filter(abs(value) > 0.4) %>%
  filter(Var1 %in% hydrogenase_normalized$`New Class` & Var2 %in% cazy_normalized$cazy.family) -> edges

edges %>%
  igraph::graph.data.frame(directed=FALSE) -> g

V(g)$type <- V(g)$name %in% edges[,2] #the second column of edges is TRUE type
E(g)$weight <- as.numeric(edges[,3])

g %>%
  #igraph::add_layout_(igraph::as_bipartite()) %>%
  igraph::plot.igraph()




```

