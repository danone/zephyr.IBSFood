---
title: "large correlation analysis"
output: html_notebook
---



```{r}

library(dplyr)
library(magrittr)
library(ggplot2)
devtools::load_all()

```


```{r, message=FALSE, warning=FALSE}

infraspecies = readr::read_csv2(system.file("infraspecies", "infraspecies_table_full.csv", package="IBSFood"))[,-1]

nutrient_taxa_cor = read.csv2(file="nutrient_taxa_cor.csv", row.names=1)


```


## prepare compo table

filter low abundant subspecies


```{r}

infraspecies %>% dim

infraspecies %>%
  filter(genus!="Homo") %>%
  mutate_at(vars(contains("M", ignore.case = F)),function(x){x/sum(x)}) %>%
  as.data.frame() %>%
  tibble::column_to_rownames("msp_name_partition") %>%
  select(contains("M", ignore.case = F)) %>%
  BiotypeR::noise.removal(percent=0.1) %>% row.names -> infraspecies_select
  #summarise_all(funs(sum)) %>% t %>%
  #summary




```




melt composition table at each tax level
```{r}



rbind(
infraspecies %>%
  mutate_at(vars(contains("M", ignore.case = F)),function(x){x/sum(x)}) %>%
  filter(msp_name_partition %in% infraspecies_select) %>%
  select(contains("M", ignore.case = F),phylum) %>%
  group_by(phylum) %>%
  summarise_all(sum) %>%
  reshape2::melt(id.vars="phylum") %>%
  mutate(taxa = "phylum") %>%
  dplyr::rename(tax_variable = phylum),


infraspecies %>%
  mutate_at(vars(contains("M", ignore.case = F)),function(x){x/sum(x)}) %>%
  filter(msp_name_partition %in% infraspecies_select) %>%
  select(contains("M", ignore.case = F),phylum,family) %>%
  group_by(phylum,family) %>%
  summarise_all(sum) %>%
  ungroup() %>%
  select(-phylum) %>%
  reshape2::melt(id.vars="family")%>%
  mutate(taxa = "family") %>%
  dplyr::rename(tax_variable = family),


infraspecies %>%
  mutate_at(vars(contains("M", ignore.case = F)),function(x){x/sum(x)}) %>%
  filter(msp_name_partition %in% infraspecies_select) %>%
  select(contains("M", ignore.case = F),phylum,family,genus) %>%
  group_by(phylum,family,genus) %>%
  summarise_all(sum) %>%
  ungroup() %>%
  select(-phylum,-family) %>%
  reshape2::melt(id.vars="genus") %>%
  mutate(taxa = "genus") %>%
  dplyr::rename(tax_variable = genus),


infraspecies %>%
  mutate_at(vars(contains("M", ignore.case = F)),function(x){x/sum(x)}) %>%
  filter(msp_name_partition %in% infraspecies_select) %>%
  select(contains("M", ignore.case = F),phylum,family,genus,msp_name) %>%
  group_by(phylum,family,genus,msp_name) %>%
  summarise_all(sum) %>%
  ungroup() %>%
  select(-phylum,-family,-genus) %>%
  reshape2::melt(id.vars="msp_name") %>%
  mutate(taxa = "MSP") %>%
  dplyr::rename(tax_variable = msp_name),


infraspecies %>%
  mutate_at(vars(contains("M", ignore.case = F)),function(x){x/sum(x)}) %>%
  filter(msp_name_partition %in% infraspecies_select) %>%
  select(contains("M", ignore.case = F),phylum,family,genus,msp_name, msp_name_partition) %>%
  group_by(phylum,family,genus,msp_name, msp_name_partition) %>%
  summarise_all(sum) %>%
  ungroup() %>%
  select(-phylum,-family,-genus, -msp_name) %>%
  reshape2::melt(id.vars="msp_name_partition") %>%
  mutate(taxa = "Infraspecies") %>%
  dplyr::rename(tax_variable = msp_name_partition)
) -> compo_taxa_melt




compo_taxa_melt %>% head



```



## correlation with nutrient

```{r}


data("nutrients_data")

nutrients_data %>%
  reshape2::melt(id.vars="ID") %>%
  merge(.,compo_taxa_melt, by.y="variable", by.x="ID") -> compo_taxa_nutrient_melt
  


compo_taxa_nutrient_melt %>% 
  #filter(variable == "Niek _mg" | tax_variable == "msp_1265_unassigned" | tax_variable =="msp_0849_cl_1"| tax_variable == "msp_0849") %>%
  group_by(taxa,tax_variable,variable) %>%
  summarize(cor = cor(value.x,value.y, method="spearman")) -> nutrient_taxa_cor




```



## large permanova with food unifrac

```{r, message=FALSE, warning=FALSE}
load("food_otu.rda")

load("food_unifrac.dist")




id = intersect(attr(food_unifrac, "Label"), colnames(infraspecies %>% select(contains("M", ignore.case = F))))


compo_taxa_food_unifrac_permanova =

compo_taxa_melt %>%
  filter(variable %in% id) %>%
  #filter(taxa == "family") %>%
  mutate(variable = variable %>% as.character) %>%
  arrange(variable) %>%
  group_by(tax_variable,taxa) %>%
  do(vegan::adonis2(food_unifrac %>% as.matrix %>% .[sort(id),sort(id)] %>% as.dist  ~ value , data=. ) %>% broom::tidy() %>% slice(1)  ) %>%
  arrange(p.value)
  

  
compo_taxa_food_unifrac_permanova %>%
  filter(tax_variable=="msp_0070")

infraspecies %>%
  filter(msp_name_partition == "msp_0070_cl_1")


infraspecies %>%
  filter(species == "Eubacterium rectale")

```




```{r}

#nutrient_taxa_cor

# infraspecies %>%
#   select(-contains("M", ignore.case = F), msp_name, msp_name_partition) %>%
#   select(msp_name_partition, msp_name, genus, phylum)


nutrient_taxa_cor %>%
  group_by(taxa,tax_variable) %>%
  filter(cor == max(abs(cor))) %>%
  arrange(desc(abs(cor))) %>%
  ggplot() + geom_density(aes(x=cor, color=taxa))




```




# tree based representation

```{r}
library(purrr)


compo_taxa_food_unifrac_permanova %>% 
  ungroup %>%
  mutate(tax_variable = ifelse(taxa=="genus", paste0("g_",tax_variable), tax_variable )) %>%
  mutate(tax_variable = ifelse(taxa=="family", paste0("f_",tax_variable), tax_variable )) %>%
  mutate(tax_variable = ifelse(taxa=="phylum", paste0("p_",tax_variable), tax_variable )) %>%
  filter(R2>0.02) %>% .$tax_variable -> tax_variable_select
  

infraspecies %>%
  mutate(root="root") %>%
  select(root,phylum,family,genus,msp_name, msp_name_partition) %>%
  filter(msp_name_partition %in% infraspecies_select) %>%
  mutate(phylum=paste0("p_",phylum), family=paste0("f_",family), genus=paste0("g_",genus)) %>%
  filter(
    msp_name_partition %in% tax_variable_select |
      msp_name %in% tax_variable_select |
      genus %in% tax_variable_select |
      family %in% tax_variable_select |
      phylum %in% tax_variable_select
    
    
  )   -> df




taxo_edges =

  map_df(2:ncol(df), ~select(df, (.x-1):.x) %>% setNames(c("source", "target")), .id="id") %>%
    group_by(id) %>%
    distinct() %>%
    ungroup() %>%
    mutate(id = colnames(df)[as.numeric(id)+1])


  

```


```{r, message=FALSE, warning=FALSE}

library(igraph)
library(ggraph)

gr <- graph_from_data_frame(taxo_edges[2:3])

names(V(gr)) %>% length



R2_permanova_diet =

compo_taxa_food_unifrac_permanova %>% 
  ungroup %>%
  mutate(tax_variable = ifelse(taxa=="genus", paste0("g_",tax_variable), tax_variable )) %>%
  mutate(tax_variable = ifelse(taxa=="family", paste0("f_",tax_variable), tax_variable )) %>%
  mutate(tax_variable = ifelse(taxa=="phylum", paste0("p_",tax_variable), tax_variable )) %>%
  tibble::column_to_rownames("tax_variable") %>%
  .[names(V(gr)),] %>%
  .$R2
 

V(gr)$R2_permanova_diet = R2_permanova_diet

R2_boolean = R2_permanova_diet > 0.02

R2_boolean[1] = FALSE

V(gr)$R2_boolean = R2_boolean


dendro = ggraph(gr, layout = 'dendrogram', circular = TRUE) + 
    geom_edge_diagonal() +
    geom_node_point(aes(color = R2_permanova_diet, size = R2_permanova_diet, filter=R2_boolean)) + 
    scale_radius() +
    viridis::scale_color_viridis() +
    coord_fixed() + theme_void()

dendro

names(V(gr))





```









